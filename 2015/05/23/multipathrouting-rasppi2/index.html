<!DOCTYPE html>
<html lang="en-GB">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="/xmlrpc.php">
	<title>Multipath routing on a Raspberry Pi 2 &#8211; whizzy.org</title>
<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//s.w.org">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Comments Feed" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Multipath routing on a Raspberry Pi 2 Comments Feed" href="/2015/05/23/multipathrouting-rasppi2/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.2"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}</style>
	<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="googleOpenSans-css" href="//fonts.googleapis.com/css?family=Open+Sans%3A400%2C400italic%2C600%2C700%2C700italic&#038;subset=latin%2Ccyrillic&#038;ver=5.7.2" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="/wp-content/themes/emmet-lite/css/bootstrap.min.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="/wp-content/themes/emmet-lite/css/font-awesome.min.css" type="text/css" media="all">
<link rel="stylesheet" id="flexslider-css" href="/wp-content/themes/emmet-lite/css/flexslider.min.css" type="text/css" media="all">
<link rel="stylesheet" id="emmet-main-css" href="/wp-content/themes/emmet-lite/css/emmet-style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="emmet-style-css" href="/wp-content/themes/emmet-lite/style.css" type="text/css" media="all">
<script type="text/javascript" src="/wp-includes/js/jquery/jquery.min.js?ver=3.5.1" id="jquery-core-js"></script>
<script type="text/javascript" src="/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2" id="jquery-migrate-js"></script>
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/627">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 5.7.2">
<link rel="canonical" href="/2015/05/23/multipathrouting-rasppi2/">
<link rel="shortlink" href="/?p=627">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2015%2F05%2F23%2Fmultipathrouting-rasppi2%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=https%3A%2F%2F%2F2015%2F05%2F23%2Fmultipathrouting-rasppi2%2F&#038;format=xml">
    <style type="text/css" id="theme-header-css">.welcome-right {
            background: url("/wp-content/themes/emmet-lite/images/welcome-image.png") no-repeat scroll left center rgba(0, 0, 0, 0);
        }

                        .third-left {
            background: url("/wp-content/themes/emmet-lite/images/third-image.png") no-repeat scroll right center rgba(0, 0, 0, 0);
        }</style>
    <style type="text/css" id="custom-background-css">body.custom-background { background-image: url("/wp-content/themes/emmet-lite/images/main-bg.jpg"); background-position: center top; background-size: auto; background-repeat: no-repeat; background-attachment: fixed; }</style>
	</head>
<body class="post-template-default single single-post postid-627 single-format-standard custom-background emmet pages-background">
<a class="skip-link screen-reader-text" href="#main">
	Skip to content</a>
<div class="wrapper  ">
				<header id="header" class="main-header">
							<div class="top-header">
					<div class="container">
												<div class="top-menu">
							<ul id="menu-top-menu" class="menu"></ul>							<div class="clearfix"></div>
						</div>

						<div class="social-profile type1 ">
																						<a href="https://twitter.com/8none1" class="button-twitter" title="Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a>
																													<a href="https://github.com/8none1" class="button-google" title="Google +" target="_blank"><i class="fa fa-google-plus-square"></i></a>
																																											<a href="https://www.youtube.com/user/willcooke1" class="button-youtube" title="Youtube" target="_blank"><i class="fa fa-youtube-square"></i></a>
																					                            						</div>
						<div class="contact-info ">
							<ul class=" info-list">
																																																									</ul>
							<div class="clearfix"></div>
						</div>
					</div>
				</div>
							<div class="site-header" data-sticky-menu="off">
				<div class="container">
					<div class="site-logo">
													<a class="home-link" href="/" title="whizzy.org" rel="home">
                                											<div class="site-description">
									<p class="site-title ">whizzy.org</p>
																			<p class="site-tagline">On code and gadgets.</p>
																	</div>
							</a>
											</div>
                    <button class="menu-toggle" aria-controls="main-menu" aria-expanded="false"><span class="menu-show">Menu</span>
                        <span class="menu-close">Close</span>
                        
                    </button>
					<div id="navbar" class="navbar">
						<nav id="site-navigation" class="main-navigation">
							<ul class="sf-menu"></ul>						</nav>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
		</header>
		<div id="main" class="site-main">
<div class="header-image-wrapper">
    <div class="header-image with-header-image " style="background-image: url(/wp-content/themes/emmet-lite/images/headers/bg.png);">
        <div class="container">
                            <h1 class="page-title">Multipath routing on a Raspberry Pi 2</h1>
                    </div>
    </div>
</div>
<div class="container main-container">
    <div class="row clearfix">
        <div class=" col-xs-12 col-sm-12 col-md-8 col-lg-8">
                            <article id="post-627" class="post-627 post type-post status-publish format-standard hentry category-linux category-raspberrypi">
    <div class="entry-content">
                            <p><strong>Skill level:</strong>  <em>Not for the faint hearted!</em></p>
<p>A few years ago, when I started working at home, I had a second ADSL line installed so that I could still get online if my ISP had an outage.  As well as fault tolerance I wanted to try and use all the available bandwidth rather than just have it sitting there &#8220;just in case&#8221;.  I achieved this using multi path routing and documented the solution here:  <a href="/2012/03/over-engineering-ftw/" target="_blank" rel="noopener noreferrer">Over Engineering FTW</a>.</p>
<p>This has been running really well on a Raspberry Pi for about 3 years (with an older kernel, see later in this post for why) but recently the SD card has started to fail.  Although this would be easy to fix; simply replace the SD card and copy my scripts over, the rural town I live in has just been upgraded to FTTC and so my connection speed has gone from about 8 Mbps to about 70 Mbps on each line.  The first generation Pi doesn&#8217;t have enough horsepower to cope with 70 Mbps let alone 140Mbps, and indeed the ethernet interface is only 100Mbps.  I had a Raspberry Pi 2 spare anyway so I figured I would use that and add a second gigabit NIC so I could cope with the theoretical 140 Mbps connection to the internet, and since I had two NICs I might as well use both of them.</p>
<h2>Physical layout</h2>
<p>This is what I came up with:</p>
<p><a href="http://whizzy.org/wp-content/uploads/2015/05/New-network-config.png"><img loading="lazy" class="alignleft size-medium wp-image-631" src="/wp-content/uploads/2015/05/New-network-config-267x300.png" alt="New network config" width="267" height="300" srcset="/wp-content/uploads/2015/05/New-network-config-267x300.png 267w, /wp-content/uploads/2015/05/New-network-config-768x864.png 768w, /wp-content/uploads/2015/05/New-network-config.png 849w" sizes="(max-width: 267px) 100vw, 267px"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<ul>
<li>Two lines coming from the cabinet to my house, one with Plusnet and one with TalkTalk</li>
<li>The Plusnet line:
<ul>
<li>It came with an OpenReach vDSL bridge and a crappy locked down router, so I chucked the router away and used PPPoE tools to bring up the PPP connection</li>
<li>The vDSL bridge talks to the Raspberry Pi over a VLAN to keep it separated from the other noise on the switch</li>
<li>Interface eth1.1000 is an unnumbered interface and ppoeconf uses a layer 2 discovery protocol to find the bridge</li>
<li>Once the PPP connection is established ppp1 can be used to route traffic to the internet</li>
</ul>
</li>
<li>The TalkTalk line:
<ul>
<li>It too came with a crappy router, but no OpenReach bridge.  So I had to use it.</li>
<li>The TalkTalk router talks to the Raspberry Pi over VLAN 10.  Those ports are untagged on the switch, so as far as everyone on that network knows its just a self contained LAN.</li>
<li>Interface eth0 on the Raspberry Pi has an address on that LAN and uses the TalkTalk router to talk to the internet</li>
</ul>
</li>
<li>The main LAN:
<ul>
<li>Interface eth1 is used to connect to the main LAN</li>
<li>Clients on the LAN use the Raspberry Pi as their default gateway</li>
</ul>
</li>
</ul>
<p>With me so far?  Essentially we have the normal eth0 interface of the Pi connected to one LAN with its own router and eth1 (a USB gigabit ethernet adapter) has a tagged VLAN for connection to the OpenReach bridge (eth1.1000) and an untagged default network for connecting the the main LAN.  Once the layer 2 connection with the bridge is established a PPP connection becomes the second route to the internet.</p>
<h2>The death of route caching</h2>
<p>Around version 3.6 of the Linux kernel &#8220;route caching&#8221; was <a href="http://git.kernel.org/cgit/linux/kernel/git/davem/net-next.git/commit/?id=89aef8921bfbac22f00e04f8450f6e447db13e42">removed</a>.  With route caching in place you could set up a default route with multiple hops, something along the lines of:</p>
<p>ip route add default nexthop via 192.168.1.254 dev eth0 nexthop via 192.168.2.254 dev eth1</p>
<p>When a packet needed routing to the internet the kernel would do a round-robin selection of which route to use and then <em>remember that route</em> for a period of time.  The upshot of this was, for example, that if you connected to www.bbc.co.uk and got routed first via 192.168.1.254 and so SNATed to 212.159.20.70 then all subsequent traffic for that destination also got routed via the same route and had the same source IP address.  <span style="text-decoration: underline;">Without</span> route caching the next <em>packet</em> to that same destination would (probably) use the other route, and in the case of my home user scenario would arrive from a different source IP address &#8211; my two internet connections having different IP addresses.  Although HTTP is a connectionless protocol this change of IP address did seem to freak some services out.  For protocols with connections the story is worse, e.g. packets of an SSH connection would arrive at the far end from from two different IP addresses and probably get dropped.  Route caching was a simple fix for this issue and worked well, as far as I was concerned anyway.</p>
<p>Im sure the reasons to remove it are valid, but for my simple use case it worked very well and the alternative, and now <em>only</em> option is to use connection marking to simulate the route caching.  When I first looked at it I was baffled and thought I would just go back to a pre 3.6 kernel and use route caching again.  But, in the standard Raspbian distro there isn&#8217;t a kernel old enough for the Raspberry Pi 2 to make use of it.</p>
<p>So I was stuck&#8230;  I had to use a Raspberry Pi 2 to get enough packet throughput to max out my internet connections, and I couldn&#8217;t use route caching because there wasn&#8217;t a kernel old enough.  This meant I was going to have to either compile my own kernel or learn to use connection marking.  Joy.</p>
<h2>Alternative projects</h2>
<p>The documentation for <a href="http://www.netfilter.org/">Netfilter</a> is extensive but I found a lot of it to be out of date and very hard to grok.  I found a few projects who had already implemented connection tracking/marking namely <a href="http://sourceforge.net/projects/humbertolj/">FWGuardian</a> and <a href="https://github.com/drsound/fault_tolerant_router">Fault Tolerant Router</a>.</p>
<p>FWGuardian is, as far as I can tell, designed for something orthogonal to my set up.  Where you might have lots of connections coming in to a server, or a number of offices which need to connect to other offices via pre-defined routes.  I played around with it for a while, and Humberto very kindly offered me support over email, but ultimately it was too involved and complex for my needs.  You should check out the project though if you have advanced requirements.  It&#8217;s got some brilliant features for a more enterprise oriented setup.</p>
<p>Fault Tolerant Router is a much simpler setup and matched my requirements very closely.  At it&#8217;s core it&#8217;s a Ruby script which can write your iptables rules and routing tables and constantly monitor the links.  If one goes down it can dynamically rewrite your rules and direct all traffic down the working connection.  However, it&#8217;s not expecting to use a PPP connection where gateways can change and it&#8217;s not really been tested with VLANs, although in practice it handled VLANs just fine.</p>
<p>But, at the end of the day, I wanted to learn how to do this myself and so I used the rules generated by Fault Tolerant Router to understand how connection marking was supposed to work and then started to implement my own home-grown solution for teh lolz.</p>
<h2>Multi-path routing and connection marking</h2>
<p>As I understand it, the idea with connection marking, or connection tracking &#8211; I&#8217;m not sure what the difference is, is that when a new conversation starts the packets are marked with an identifier.  You can then set <em>ip rules</em> to dictate which route packets with a particular mark take.  In essence once a new connection is established and a route selected, all other packets in that conversation take on the same mark and so the same route.  This emulates the route caching of the past.  I don&#8217;t really get how, in the case of an HTTP conversation (or flow) which is connectionless, all the packets in the conversation get marked the same.  <a href="http://www.rigacci.org/wiki/lib/exe/fetch.php/doc/appunti/linux/sa/iptables/conntrack.html">This page</a> has some more details, but I haven&#8217;t read it properly yet.  Anyway, we don&#8217;t know <em>HOW</em> it works, but it does.  Good enough.</p>
<h3>IPtables</h3>
<p>First of all we need to create the iptables configuration to set up connection marking.  Here&#8217;s the relevant extract from the iptables.save file:</p>
<pre><code>*mangle
 :PREROUTING ACCEPT [0:0]
 :POSTROUTING ACCEPT [0:0]
 :OUTPUT ACCEPT [0:0]
 :INPUT ACCEPT [0:0]
 [0:0] -A PREROUTING -i eth1 -j CONNMARK --restore-mark</code>
 <code>[0:0] -A PREROUTING -i ppp1 -m conntrack --ctstate NEW -j CONNMARK --set-mark 1</code>
 <code>[0:0] -A PREROUTING -i eth0 -m conntrack --ctstate NEW -j CONNMARK --set-mark 2</code>
 <code>[0:0] -A POSTROUTING -o ppp1 -m conntrack --ctstate NEW -j CONNMARK --set-mark 1</code>
 <code>[0:0] -A POSTROUTING -o eth0 -m conntrack --ctstate NEW -j CONNMARK --set-mark 2</code></pre>
<p><span style="color: #d5d9e8;">-i = &#8211;in-interface and -0 = &#8211;out-interface</span></p>
<p>These rules set a mark depending on which interface is used.  These changes happen in the mangle table.</p>
<p>Packets going in or out the WAN via ppp1 or eth0 which are a <strong>new</strong> connection are marked with a 1 or a 2 depending on which interface they use.  The decision about which route to use is done in the rules which we will see later.  Any packets coming in to eth1, so from the LAN, have their marks restored on the way in so they can be dealt with accordingly.</p>
<p>Now let&#8217;s have a look at the filter table:</p>
<pre><code>*filter</code>
 <code>:INPUT DROP [0:0]</code>
 <code>:FORWARD DROP [0:0]</code>
 <code>:OUTPUT ACCEPT [0:0]</code>
 <code>:LAN_WAN - [0:0]</code>
 <code>:WAN_LAN - [0:0]</code></pre>
<pre><code>[0:0] -A INPUT -i lo -j ACCEPT</code>
 <code>[0:0] -A INPUT -i eth1 -j ACCEPT</code>
 <code>[0:0] -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</code></pre>
<pre><code>[0:0] -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</code>
 <code>[0:0] -A FORWARD -i eth1 -o ppp1 -j LAN_WAN</code>
 <code>[0:0] -A FORWARD -i eth1 -o eth0 -j LAN_WAN</code>
 <code>[0:0] -A FORWARD -i ppp1 -o eth1 -j WAN_LAN</code>
 <code>[0:0] -A FORWARD -i eth0 -o eth1 -j WAN_LAN</code></pre>
<pre><code>## Clamp MSS (ideal for PPPoE connections)</code>
 <code>[0:0] -I FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</code>
 <code>[0:0] -A LAN_WAN -j ACCEPT</code>
 <code>[0:0] -A WAN_LAN -j REJECT</code></pre>
<p>The default policy is set to DROP, so any packet not matching one of the rules are dropped.</p>
<p>INPUT applies to packets which are bound for the router itself.  Packets from the local interface are allowed, and packets from eth1 (the main LAN) are also allowed.</p>
<p>FORWARD applies to packets which are passing through the router on their way somewhere else.  Packets which are known to be part of an already in-progress session are allowed.  Packets are then categorised as LAN to WAN or WAN to LAN and dealt with by the rules LAN_WAN or WAN_LAN, getting accepted and rejected respectively.  All this boils down to LAN clients using the Raspberry Pi as a router and so having their packets forwarded are allowed out and packets coming in from the internet are rejected, the exception being if they are part of an on-going connection.</p>
<p>Clamping MSS to MTU deals with a particular issue with using PPPoE connections where the MTU can&#8217;t be the usual 1500 bytes.  Because a lot of ISPs block the ICMP messages that would normally deal with asking the client to send smaller packet sizes we use this handy trick to make sure that packets can go out unfragmented.  If you find that some web pages are slow to load and others are not, then try switching this on.  If you&#8217;re only using upstream ISP provided routers you probably don&#8217;t need this.</p>
<p>Lastly in iptables we enable SNAT or masquerading so that connections out to the internet appear to come from a valid internet routable IP address not our LAN IP address:</p>
<pre><code>#SNAT: LAN --&gt; WAN</code>
 <code>[0:0] -A POSTROUTING -o ppp1 -j SNAT --to-source 212.159.20.70</code>
 <code>[0:0] -A POSTROUTING -o eth0 -j SNAT --to-source 192.168.1.253</code></pre>
<h3>Routing tables</h3>
<p>We&#8217;ve configured iptables to add a mark to traffic depending on which WAN interface it is going in or out of.  But this is only marking the packets, there is no logic to make sure that packets of the same mark use the same route.  To make this happen we use ip rules.</p>
<p>First create three new routing tables by editing /etc/iproute2/rt_tables.  I&#8217;ve added this to the bottom:</p>
<pre><code>1 plusnet</code>
 <code>2 talktalk</code>
 <code>3 loadbal</code></pre>
<p>Now we add a default route to the first two of those tables:</p>
<pre><code>ip route add default via $PPP_GATEWAY_ADDRESS dev ppp1 src 212.159.20.70 table plusnet
</code><code>ip route add default via 192.168.1.254 dev eth0 src 192.168.1.253 table talktalk</code></pre>
<p>$PPP_GATEWAY_ADDRESS is set when the PPP session is established and changes.  We can look at ways to find that address later, but for now just substitute the &#8220;P-t-P&#8221; IP address from &#8220;<code>ifconfig ppp1</code>&#8221; or whatever your ppp interface number is, or in the case of an ISP-provided router, the LAN side IP of that router.</p>
<p>This is simply creating a routing table with the name of the ISP that will be used and a default route which can find its way to the internet for that ISP.</p>
<p>Next we create the loadbal routing table which is a combination of the previous two:</p>
<pre><code>ip route add default table loadbal nexthop via $PPP_GATEWAY_ADDRESS dev ppp1 nexthop via 192.168.1.254 dev eth0</code></pre>
<p>which is the same idea as we used in the old route caching days, a round-robin route which flicks between the two available routes to the internet.</p>
<h3>ip rules</h3>
<p>We&#8217;ve now created the iptables entries to track and mark traffic from each of the two ISPs and add some basic firewalling and IP masquerading.  We&#8217;ve also created a routing table for each ISP and a load-balancing table which splits the traffic between the two ISPs.</p>
<p>Now we need to create some rules to govern which of the routing tables is used for a particular connection.  The commands to do this are:</p>
<pre><code>ip rule add from $PPP_IPADDR table plusnet pref 40000
ip rule add from 192.168.1.253 table talktalk pref 40100
ip rule add fwmark 0x1 table plusnet pref 40200
ip rule add fwmark 0x2 table talktalk pref 40300
ip rule add from 0/0 table loadbal pref 40400</code></pre>
<p>The rules are matched in numerical order based on preference and once a rule matches that&#8217;s it.  The first two rules make sure that traffic from the routers uses the correct table.</p>
<p>The important rules are the last three.  Traffic which has been marked &#8220;1&#8221; will always use the plusnet routing table, traffic marked as &#8220;2&#8221; will always use the talktalk routing table.  This ensures that all traffic which is part of an on-going conversation will always use the same router out to the internet, and so always come from the same IP address.</p>
<p>The last rule only matches traffic which is not already marked i.e. new conversations.  This routing table, as can be seen in the previous section, has a multi-path route to balance traffic between the two routes out.  Once a conversation is established the IPtables conntrack rules will mark the traffic and so one of the two fwmark rules will match.</p>
<p>Now delete the main default route so that the above rules don&#8217;t get bypassed with a route in the &#8220;main&#8221; table:</p>
<pre><code>ip route del default</code></pre>
<p>And that&#8217;s it.  You should now have a router which splits the traffic fairly evenly across two internet connections and keeps tabs on which packets should go out of which routers.  I&#8217;ve had this running for a month or so now, and it seems to be working fine.  I&#8217;ve had the Pi lock up a couple of times, but I think that&#8217;s related to the USB gigabit ethernet adapter.</p>
<h2>Smart Netflix hacks</h2>
<p>Services such as <a href="https://www.unblock-us.com/">unblock-us</a> allow you to work around some geographic content blocks by acting as your DNS server and replying with the IP address of, say, the US based Netflix server instead of the UK ones.  I&#8217;ve installed dnsmasq on my Pi as well and configured it to use the Unblock DNS servers instead of my ISP or Google servers.  The clients on the LAN get their network configuration over DHCP from the Pi which sets the DNS server address for the clients to the Pi itself which then handles DNS lookups using the Unblock servers upstream.  This works really well for most Netflix clients but I was having a lot of problems getting the Chromecast to work with Netflix and Unblock US.</p>
<p>It turns out that Google have hard-coded it&#8217;s own DNS servers into the Chromecast and so your local DNS settings are ignored.  Nice one Google.</p>
<p>Because we&#8217;re using a Linux box as our router we can do this:</p>
<pre><code>iptables -t nat -A PREROUTING -s &lt;Netflix Client IP&gt;/32 -d 8.8.8.8 -p udp --dport 53 -j DNAT --to &lt;Alternative DNS Server IP Address&gt;
 iptables -t nat -A PREROUTING -s &lt;Netflix Client IP&gt;/32 -d 8.8.4.4 -p udp --dport 53 -j DNAT --to &lt;Alternative DNS Server IP Address&gt;</code></pre>
<p>Using the NAT table we rewrite the DNS lookup bound for Google&#8217;s DNS servers to send it to our dnsmasq server instead. lol.</p>
<h2>Spreading interrupts across cores</h2>
<p>Network cards have queues for tx and rx.  Higher end cards will typically have more queues, but on the Pi the on-board NIC (which is actually connected via USB) has one for tx and one for rx, as do the VLAN interfaces and the PPP interfaces.  Each of these queues has a CPU affinity and it seems that by default the queues all use the same CPU core.</p>
<p>When downloading an ISO with BitTorrent and the load-balancing set up I was able to achieve just over 10 MBytes a second.  But the Pi became really unresponsive.  Looking at top showed one CPU core maxed out in soft interrupts:</p>
<p><a href="http://whizzy.org/wp-content/uploads/2015/05/without_queues_spread.png"><img loading="lazy" class="alignleft size-medium wp-image-636" src="/wp-content/uploads/2015/05/without_queues_spread-300x159.png" alt="without_queues_spread" width="300" height="159" srcset="/wp-content/uploads/2015/05/without_queues_spread-300x159.png 300w, /wp-content/uploads/2015/05/without_queues_spread-1024x544.png 1024w, /wp-content/uploads/2015/05/without_queues_spread-768x408.png 768w, /wp-content/uploads/2015/05/without_queues_spread-1536x816.png 1536w, /wp-content/uploads/2015/05/without_queues_spread-1200x638.png 1200w, /wp-content/uploads/2015/05/without_queues_spread.png 1735w" sizes="(max-width: 300px) 100vw, 300px"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>By adjusting the CPU affinity to spread these IRQs across multiple CPUs I squeeze out a tiny bit more network throughput, but more usefully the Pi remained responsive under heavy load:</p>
<p><a href="http://whizzy.org/wp-content/uploads/2015/05/with_queues_spread.png"><img loading="lazy" class="alignleft size-medium wp-image-637" src="/wp-content/uploads/2015/05/with_queues_spread-300x162.png" alt="with_queues_spread" width="300" height="162" srcset="/wp-content/uploads/2015/05/with_queues_spread-300x162.png 300w, /wp-content/uploads/2015/05/with_queues_spread-1024x553.png 1024w, /wp-content/uploads/2015/05/with_queues_spread-768x415.png 768w, /wp-content/uploads/2015/05/with_queues_spread-1536x830.png 1536w, /wp-content/uploads/2015/05/with_queues_spread-1200x649.png 1200w, /wp-content/uploads/2015/05/with_queues_spread.png 1902w" sizes="(max-width: 300px) 100vw, 300px"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>The commands I used to do this are:</p>
<pre><code>echo 1 &gt; /sys/class/net/eth0/queues/rx-0/rps_cpus
echo 1 &gt; /sys/class/net/eth0/queues/tx-0/xps_cpus
echo 2 &gt; /sys/class/net/eth1/queues/tx-0/xps_cpus
echo 2 &gt; /sys/class/net/eth1/queues/rx-0/rps_cpus
echo 4 &gt; /sys/class/net/eth1.1000/queues/tx-0/xps_cpus
echo 4 &gt; /sys/class/net/eth1.1000/queues/rx-0/rps_cpus
echo 8 &gt; /sys/class/net/ppp1/queues/tx-0/xps_cpus
echo 8 &gt; /sys/class/net/ppp1/queues/rx-0/rps_cpus</code></pre>
<h2>Source</h2>
<p>Here&#8217;s a tgz file containing my iptables rules and a script to set up the above: <a href="/wp-content/uploads/2015/05/routing.tgz">routing</a></p>
<p><em><strong>Update:</strong></em>  I&#8217;ve put the files in this Github repo:  <a href="https://github.com/8none1/multipathrouting">https://github.com/8none1/multipathrouting</a></p>
<p>If you&#8217;re interested in helping to make the scripts a bit more generic and adding fault-tolerance let me know.</p>
        
        <div class="clearfix"></div>
            </div>
<!-- .entry-content -->
    <footer class="entry-footer">
                    <div class="meta">
                <span class="author">Posted by </span><a href="/author/will/" title="Posts by will" rel="author">will</a>                <span class="seporator">/</span>
                <span class="date-post h6">May 23, 2015</span>
                                            </div>        
                             
                                                        <div class="wrapper-post-categories">
                    <h5>Posted in</h5>
                    <a href="/category/linux/" rel="category tag">linux</a><span>,</span> <a href="/category/raspberrypi/" rel="category tag">RaspberryPi</a>                    <div class="clearfix"></div>
                </div>
                                    
    </footer><!-- .entry-meta -->
</article><!-- #post -->                
<div id="comments" class="comments-area">

            <h5 class="comments-title">7 Comments</h5>
        <ol class="comment-list">
                <liclass even thread-even depth-1 id="comment-62">
        <div id="div-comment-62" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
        <img alt="" src="https://secure.gravatar.com/avatar/dd15b79ca7ff13251eb6e49471498c48?s=72&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/dd15b79ca7ff13251eb6e49471498c48?s=144&#038;d=mm&#038;r=g 2x" class="avatar avatar-72 photo" height="72" width="72" loading="lazy">    </div>
    <div class="comment-content">
    <h4 class="fn">Flo</h4>        <div class="comment-meta commentmetadata date-post h6">
        May 25, 2015 <span>at 8:39 am</span>            </div>
    <p>Thank you so much for this tutorial. It explains some really advanced concepts very well. Keep up the good work!!!</p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <!-- #comment-## -->
    <liclass odd alt thread-odd thread-alt depth-1 id="comment-63">
        <div id="div-comment-63" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
            </div>
    <div class="comment-content">
    <h4 class="fn"><a href="http://chris.cothrun.com/2015/05/25/bookmarks-for-may-25th-4/" rel="external nofollow ugc" class="url">Bookmarks for May 25th | Chris&#039;s Digital Detritus</a></h4>        <div class="comment-meta commentmetadata date-post h6">
        May 26, 2015 <span>at 12:01 am</span>            </div>
    <p>[&#8230;] Multipath routing on a Raspberry Pi 2 &mdash; whizzy.org &#8211; [&#8230;]</p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <!-- #comment-## -->
    <liclass even thread-even depth-1 parent id="comment-64">
        <div id="div-comment-64" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
        <img alt="" src="https://secure.gravatar.com/avatar/ee2e415b88b0e2d571721934970b7f4f?s=72&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/ee2e415b88b0e2d571721934970b7f4f?s=144&#038;d=mm&#038;r=g 2x" class="avatar avatar-72 photo" height="72" width="72" loading="lazy">    </div>
    <div class="comment-content">
    <h4 class="fn">Paul Taylor</h4>        <div class="comment-meta commentmetadata date-post h6">
        December 12, 2016 <span>at 8:00 am</span>            </div>
    <p>Newer kernels (4.4 onwards) have fixed this with a flow-based multipath algorithm.<br>
See:<br>
<a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=07355737a8badd951e6b72aa8609a2d6eed0a7e7" rel="nofollow ugc">https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=07355737a8badd951e6b72aa8609a2d6eed0a7e7</a></p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <ol class="children">
    <liclass byuser comment-author-will bypostauthor odd alt depth-2 parent id="comment-65">
        <div id="div-comment-65" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
        <img alt="" src="https://secure.gravatar.com/avatar/ad368ae612310967c8023a78d40bf35e?s=72&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/ad368ae612310967c8023a78d40bf35e?s=144&#038;d=mm&#038;r=g 2x" class="avatar avatar-72 photo" height="72" width="72" loading="lazy">    </div>
    <div class="comment-content">
    <h4 class="fn"><a href="/" rel="external nofollow ugc" class="url">Will Cooke</a></h4>        <div class="comment-meta commentmetadata date-post h6">
        December 15, 2016 <span>at 2:12 pm</span>            </div>
    <p>Thanks for the pointer Paul, much appreciated.<br>
I&#8217;ll do some reading over Christmas with a view to moving over to this.</p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <ol class="children">
    <liclass even depth-3 parent id="comment-66">
        <div id="div-comment-66" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
        <img alt="" src="https://secure.gravatar.com/avatar/5a8dfca7e6bd7356d0d5d63bc96dea53?s=72&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/5a8dfca7e6bd7356d0d5d63bc96dea53?s=144&#038;d=mm&#038;r=g 2x" class="avatar avatar-72 photo" height="72" width="72" loading="lazy">    </div>
    <div class="comment-content">
    <h4 class="fn"><a href="http://my-techno-arena.blogspot.in/" rel="external nofollow ugc" class="url">Abraham Varghese</a></h4>        <div class="comment-meta commentmetadata date-post h6">
        January 28, 2017 <span>at 4:41 am</span>            </div>
    <p>HI This is regarding &#8220;Multipath Routing On A Raspberry Pi 2&#8221; article. It really good and working for me. But only one glitch. I&#8217;ve 3 WAN connect to internet, having their on DNS dedicated server IP&#8217;s. i.e, We&#8217;ve to query the exact DNS IP pertains to the WAN connection.</p>
<p>Now the issue is Ubuntu has only one /etc/resolve.conf and at a time able to connect to a single DNS populated by the last active connection. So during a multipath scenario, DNS query fails for the other WAN connections. Is there a workaround for this?</p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <ol class="children">
    <liclass byuser comment-author-will bypostauthor odd alt depth-4 id="comment-67">
        <div id="div-comment-67" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
        <img alt="" src="https://secure.gravatar.com/avatar/ad368ae612310967c8023a78d40bf35e?s=72&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/ad368ae612310967c8023a78d40bf35e?s=144&#038;d=mm&#038;r=g 2x" class="avatar avatar-72 photo" height="72" width="72" loading="lazy">    </div>
    <div class="comment-content">
    <h4 class="fn"><a href="/" rel="external nofollow ugc" class="url">Will Cooke</a></h4>        <div class="comment-meta commentmetadata date-post h6">
        January 31, 2017 <span>at 9:45 am</span>            </div>
    <p>I&#8217;d suggest you run something like dnsmasq on the router which would handle the DNS resolution for you.  You can configure it to look at more than one server.</p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <!-- #comment-## -->
</liclass>
</ol>
<!-- .children -->
<!-- #comment-## -->
</liclass>
</ol>
<!-- .children -->
<!-- #comment-## -->
</liclass>
</ol>
<!-- .children -->
<!-- #comment-## -->
    <liclass even thread-odd thread-alt depth-1 id="comment-68">
        <div id="div-comment-68" class="comment-body">
    <div class="comment-description">
    <div class="comment-author vcard">
        <img alt="" src="https://secure.gravatar.com/avatar/74716fa2d8c62ddbeb08f0b6115be0d9?s=72&#038;d=mm&#038;r=g" srcset="https://secure.gravatar.com/avatar/74716fa2d8c62ddbeb08f0b6115be0d9?s=144&#038;d=mm&#038;r=g 2x" class="avatar avatar-72 photo" height="72" width="72" loading="lazy">    </div>
    <div class="comment-content">
    <h4 class="fn">Richard Greville</h4>        <div class="comment-meta commentmetadata date-post h6">
        November 14, 2019 <span>at 6:58 am</span>            </div>
    <p>Good article, thank you!</p>

    <div class="reply">
            </div>
        </div>
    </div>
    </div>

    <!-- #comment-## -->
        </liclass></liclass></liclass></liclass>
</ol>
<!-- .comment-list -->

        
                    <p class="no-comments">Comments are closed.</p>
        
        
</div>
<!-- #comments -->                    </div>
        <div class=" col-xs-12 col-sm-12 col-md-4 col-lg-4">
            <aside id="sidebar">
    <div class="widget-area">
                    <div id="archives-4" class="widget widget_archive">
<h3 class="widget-title">Archives</h3>
			<ul>
					<li><a href="/2021/07/">July 2021</a></li>
	<li><a href="/2021/01/">January 2021</a></li>
	<li><a href="/2019/07/">July 2019</a></li>
	<li><a href="/2019/06/">June 2019</a></li>
	<li><a href="/2019/05/">May 2019</a></li>
	<li><a href="/2017/05/">May 2017</a></li>
	<li><a href="/2017/03/">March 2017</a></li>
	<li><a href="/2017/02/">February 2017</a></li>
	<li><a href="/2016/12/">December 2016</a></li>
	<li><a href="/2016/11/">November 2016</a></li>
	<li><a href="/2016/10/">October 2016</a></li>
	<li><a href="/2016/09/">September 2016</a></li>
	<li><a href="/2016/02/">February 2016</a></li>
	<li><a href="/2015/12/">December 2015</a></li>
	<li><a href="/2015/10/">October 2015</a></li>
	<li><a href="/2015/09/">September 2015</a></li>
	<li><a href="/2015/06/">June 2015</a></li>
	<li><a href="/2015/05/">May 2015</a></li>
	<li><a href="/2015/02/">February 2015</a></li>
	<li><a href="/2014/08/">August 2014</a></li>
	<li><a href="/2014/02/">February 2014</a></li>
	<li><a href="/2014/01/">January 2014</a></li>
	<li><a href="/2013/12/">December 2013</a></li>
	<li><a href="/2013/11/">November 2013</a></li>
	<li><a href="/2013/02/">February 2013</a></li>
	<li><a href="/2012/11/">November 2012</a></li>
	<li><a href="/2012/08/">August 2012</a></li>
	<li><a href="/2012/03/">March 2012</a></li>
	<li><a href="/2011/09/">September 2011</a></li>
	<li><a href="/2011/08/">August 2011</a></li>
	<li><a href="/2011/07/">July 2011</a></li>
	<li><a href="/2011/06/">June 2011</a></li>
	<li><a href="/2011/04/">April 2011</a></li>
	<li><a href="/2011/02/">February 2011</a></li>
	<li><a href="/2010/10/">October 2010</a></li>
	<li><a href="/2010/09/">September 2010</a></li>
	<li><a href="/2010/08/">August 2010</a></li>
	<li><a href="/2010/06/">June 2010</a></li>
	<li><a href="/2010/01/">January 2010</a></li>
	<li><a href="/2009/10/">October 2009</a></li>
	<li><a href="/2009/09/">September 2009</a></li>
	<li><a href="/2009/08/">August 2009</a></li>
	<li><a href="/2009/07/">July 2009</a></li>
	<li><a href="/2009/06/">June 2009</a></li>
	<li><a href="/2009/05/">May 2009</a></li>
			</ul>

			</div>
		<div id="recent-posts-2" class="widget widget_recent_entries">
		<h3 class="widget-title">Recent Posts</h3>
		<ul>
											<li>
					<a href="/2021/07/14/finally-moving-to-a-static-site/">Finally moving to a static site</a>
									</li>
											<li>
					<a href="/2021/01/02/double-helping-of-pi-hole/">Double helping of Pi Hole</a>
									</li>
											<li>
					<a href="/2019/07/16/dns-over-https-in-a-snap/">DNS over HTTPS in a snap</a>
									</li>
											<li>
					<a href="/2019/06/11/whizzy-labs-wireless-sensor/">Whizzy Labs Wireless Sensor</a>
									</li>
											<li>
					<a href="/2019/05/07/ubuntu-developer-desktop-survey-2019/">Ubuntu Developer Desktop Survey 2019</a>
									</li>
					</ul>

		</div>
<div id="categories-4" class="widget widget_categories">
<h3 class="widget-title">Categories</h3>
			<ul>
					<li class="cat-item cat-item-2">
<a href="/category/alexa/">Alexa</a>
</li>
	<li class="cat-item cat-item-3">
<a href="/category/arduino/">Arduino</a>
</li>
	<li class="cat-item cat-item-4">
<a href="/category/asterisk/">asterisk</a>
</li>
	<li class="cat-item cat-item-5">
<a href="/category/google-maps/">Google Maps</a>
</li>
	<li class="cat-item cat-item-6">
<a href="/category/iot/">IoT</a>
</li>
	<li class="cat-item cat-item-7">
<a href="/category/javascript/">Javascript</a>
</li>
	<li class="cat-item cat-item-8">
<a href="/category/linux/">linux</a>
</li>
	<li class="cat-item cat-item-9">
<a href="/category/making-the-world-a-better-place/">Making the world a better place</a>
</li>
	<li class="cat-item cat-item-10">
<a href="/category/raspberrypi/">RaspberryPi</a>
</li>
	<li class="cat-item cat-item-12">
<a href="/category/so-called-humor/">So called humor</a>
</li>
	<li class="cat-item cat-item-13">
<a href="/category/tv/">tv</a>
</li>
	<li class="cat-item cat-item-14">
<a href="/category/ubuntu-2/">Ubuntu</a>
</li>
	<li class="cat-item cat-item-15">
<a href="/category/uncategorized/">Uncategorized</a>
</li>
			</ul>

			</div>            </div>
<!-- .widget-area -->
</aside>
        </div>
    </div>
</div>

</div>
<!-- #main -->
	<footer id="footer" class="site-footer">
		<a href="#" id="toTop" class="toTop"><i class="fa fa-angle-up"></i></a>
		<div class="footer-sidebar">
    <div class="container">
        <div class="row">            
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
        </div>
<!-- .widget-area -->
    </div>
</div>		<div class="footer-inner">
			<div class="container">
								<p class="social-profile type1 pull-right">
																<a href="https://twitter.com/8none1" class="button-twitter" title="Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a>
																					<a href="https://github.com/8none1" class="button-google" title="Google +" target="_blank"><i class="fa fa-google-plus-square"></i></a>
																															<a href="https://www.youtube.com/user/willcooke1" class="button-youtube" title="Youtube" target="_blank"><i class="fa fa-youtube-square"></i></a>
															                    
				</p>
				<p class="copyright"><span class="copyright-date">
						&copy; Copyright 2021                    </span>
										  <a href="/" title="whizzy.org" target="_blank">whizzy.org</a>
					  &#8226; Designed by <a href="https://motopress.com/" rel="nofollow" title="Premium WordPress Plugins and Themes">MotoPress</a>
					  &#8226; Proudly Powered by <a href="http://wordpress.org/" rel="nofollow" title="Semantic Personal Publishing Platform">WordPress</a>
					  				</p>
<!-- .copyright -->
			</div>
		</div>
	</footer>
</div>
<script type="text/javascript" src="/wp-includes/js/hoverIntent.min.js?ver=1.8.1" id="hoverIntent-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/superfish.min.js?ver=1.7.5" id="superfish.min-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/jquery.flexslider-min.js?ver=2.5.0" id="flexslider-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/jquery.appear.min.js?ver=0.3.6" id="jquery.appear-js"></script>
<script type="text/javascript" id="emmet-script-js-extra">
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
var template_directory_uri = {"url":"\/wp-content\/themes\/emmet-lite"};
/* ]]> */
</script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/emmet.min.js?ver=1.7.5" id="emmet-script-js"></script>
<script type="text/javascript" src="/wp-includes/js/wp-embed.min.js?ver=5.7.2" id="wp-embed-js"></script>
    <script>
        /(trident|msie)/i.test(navigator.userAgent)&&document.getElementById&&window.addEventListener&&window.addEventListener("hashchange",function(){var t,e=location.hash.substring(1);/^[A-z0-9_-]+$/.test(e)&&(t=document.getElementById(e))&&(/^(?:a|select|input|button|textarea)$/i.test(t.tagName)||(t.tabIndex=-1),t.focus())},!1);
    </script>
	</body>
</html>