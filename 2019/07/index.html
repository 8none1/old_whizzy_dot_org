<!DOCTYPE html>
<html lang="en-GB">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="/xmlrpc.php">
	<title>July 2019 &#8211; whizzy.org</title>
<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//s.w.org">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Comments Feed" href="/comments/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.2"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}</style>
	<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="googleOpenSans-css" href="//fonts.googleapis.com/css?family=Open+Sans%3A400%2C400italic%2C600%2C700%2C700italic&#038;subset=latin%2Ccyrillic&#038;ver=5.7.2" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="/wp-content/themes/emmet-lite/css/bootstrap.min.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="/wp-content/themes/emmet-lite/css/font-awesome.min.css" type="text/css" media="all">
<link rel="stylesheet" id="flexslider-css" href="/wp-content/themes/emmet-lite/css/flexslider.min.css" type="text/css" media="all">
<link rel="stylesheet" id="emmet-main-css" href="/wp-content/themes/emmet-lite/css/emmet-style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="emmet-style-css" href="/wp-content/themes/emmet-lite/style.css" type="text/css" media="all">
<script type="text/javascript" src="/wp-includes/js/jquery/jquery.min.js?ver=3.5.1" id="jquery-core-js"></script>
<script type="text/javascript" src="/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2" id="jquery-migrate-js"></script>
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 5.7.2">
    <style type="text/css" id="theme-header-css">.welcome-right {
            background: url("/wp-content/themes/emmet-lite/images/welcome-image.png") no-repeat scroll left center rgba(0, 0, 0, 0);
        }

                        .third-left {
            background: url("/wp-content/themes/emmet-lite/images/third-image.png") no-repeat scroll right center rgba(0, 0, 0, 0);
        }</style>
    <style type="text/css" id="custom-background-css">body.custom-background { background-image: url("/wp-content/themes/emmet-lite/images/main-bg.jpg"); background-position: center top; background-size: auto; background-repeat: no-repeat; background-attachment: fixed; }</style>
	</head>
<body class="archive date custom-background emmet pages-background">
<a class="skip-link screen-reader-text" href="#main">
	Skip to content</a>
<div class="wrapper  ">
				<header id="header" class="main-header">
							<div class="top-header">
					<div class="container">
												<div class="top-menu">
							<ul id="menu-top-menu" class="menu"></ul>							<div class="clearfix"></div>
						</div>

						<div class="social-profile type1 ">
																						<a href="https://twitter.com/8none1" class="button-twitter" title="Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a>
																													<a href="https://github.com/8none1" class="button-google" title="Google +" target="_blank"><i class="fa fa-google-plus-square"></i></a>
																																											<a href="https://www.youtube.com/user/willcooke1" class="button-youtube" title="Youtube" target="_blank"><i class="fa fa-youtube-square"></i></a>
																					                            						</div>
						<div class="contact-info ">
							<ul class=" info-list">
																																																									</ul>
							<div class="clearfix"></div>
						</div>
					</div>
				</div>
							<div class="site-header" data-sticky-menu="off">
				<div class="container">
					<div class="site-logo">
													<a class="home-link" href="/" title="whizzy.org" rel="home">
                                											<div class="site-description">
									<p class="site-title ">whizzy.org</p>
																			<p class="site-tagline">On code and gadgets.</p>
																	</div>
							</a>
											</div>
                    <button class="menu-toggle" aria-controls="main-menu" aria-expanded="false"><span class="menu-show">Menu</span>
                        <span class="menu-close">Close</span>
                        
                    </button>
					<div id="navbar" class="navbar">
						<nav id="site-navigation" class="main-navigation">
							<ul class="sf-menu"></ul>						</nav>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
		</header>
		<div id="main" class="site-main">
    <div class="container breadcrumb-wrapper">
        <div class="breadcrumb breadcrumbs sp-breadcrumbs"><div class="breadcrumb-trail">
<a href="/" title="whizzy.org" rel="home" class="trail-begin">Home</a> <span class="sep"><i class="fa fa-angle-right"></i></span> <a href="/2019/" title="2019">2019</a> <span class="sep"><i class="fa fa-angle-right"></i></span> <span class="trail-end">July</span>
</div></div>    </div>
<div class="container main-container">
    <div class="row clearfix">
        <div class=" col-xs-12 col-sm-12 col-md-8 col-lg-8">
                         
                                                    <article id="post-970" class="post-in-blog post post-970 type-post status-publish format-standard hentry category-iot category-linux category-raspberrypi category-ubuntu-2 category-uncategorized">
                    <header class="entry-header">
        <h2 class="entry-title">
            <a href="/2019/07/16/dns-over-https-in-a-snap/" rel="bookmark">DNS over HTTPS in a snap</a>
        </h2>
    </header> 
    <section class="entry entry-content">
        
<h2>Background Story</h2>



<p>With the recent news about the ISP UK association proposing Mozilla as &#8220;<a href="https://www.ispa.org.uk/ispa-announces-finalists-for-2019-internet-heroes-and-villains-trump-and-mozilla-lead-the-way-as-villain-nominees/">Internet villain of the year</a>&#8221; for enabling DNS over HTTPS (and subsequently changing their mind and dropping the whole category of villain of the year.  Good move I think.) I figured it was probably about time that I looked at enabling DoH at home.</p>



<p>Cloudflare have a suite of open source tools called <a href="https://github.com/cloudflare/cloudflared/">cloudflared</a> which has, among other things, a DNS over HTTPS proxy.  By default it points at their 1.1.1.1 service, but you can change that if you want to.  Note, at the time of writing there is a <a href="https://github.com/cloudflare/cloudflared/issues/113">bug</a> which seems to stop Google&#8217;s DNS service working.  If you&#8217;re looking to stop people seeing your DNS traffic then Google probably isn&#8217;t the right DNS service to use anyway.</p>



<figure class="wp-block-image size-large"><img loading="lazy" width="353" height="469" src="/wp-content/uploads/2019/07/proxy-dns.jpg" alt="" class="wp-image-972" srcset="/wp-content/uploads/2019/07/proxy-dns.jpg 353w, /wp-content/uploads/2019/07/proxy-dns-226x300.jpg 226w" sizes="(max-width: 353px) 100vw, 353px"></figure>



<p>I already have dnsmasq running as my DNS server and I have quite a lot of config which I wanted to keep (e.g. adblocking) so I figured I would add cloudflared&#8217;s proxy-dns alongside dnsmasq and have dnsmasq use proxy-dns as it&#8217;s upstream server, which would in turn pass the DNS lookups to 1.1.1.1 over HTTPS.  dnsmasq would then cache the results locally.</p>



<p>So far, so good.  I&#8217;d built cloudflared on my desktop to test it, now I wanted to move it on to the Raspberry Pi, run it as a service, and ideally have a package so that I didn&#8217;t have to mess around rebuilding it in loads of places if I wanted to move to a different box.</p>



<h2>Make a snap</h2>



<p>Making a snap of proxy-dns would give the the package I wanted, and could allow me to run proxy-dns as a daemon with two words in the YAML.  Snapcraft&#8217;s <a href="https://snapcraft.io/build">build service</a> would build me an ARM binary, as well as loads of others, for free.</p>



<p>I downloaded the source for <a href="https://github.com/cloudflare/cloudflared">cloudflared</a> and added three files:</p>



<ol>
<li>A <a href="https://github.com/8none1/cloudflaredohsnap/blob/master/snapcraft.yaml">snapcraft.yaml</a> which describes how to build cloudflared and sets it to be run as a daemon</li>
<li>A <a href="https://github.com/8none1/cloudflaredohsnap/blob/master/snap/hooks/configure">configure hook</a> which lets me set some config options</li>
<li>A <a href="https://github.com/8none1/cloudflaredohsnap/blob/master/launcher/launcher">launcher script</a> which sets the config at run time</li>
</ol>



<p>None of these are very complicated, as you can see.  Hat-tip to <a href="https://twitter.com/popey">Popey</a> for help with the snapcraft.yaml.</p>



<p>The I pushed these back to my project on <a href="https://github.com/8none1/cloudflaredohsnap">GitHub</a> and added that project to the <a href="https://snapcraft.io/build">Snapcraft.io build service</a>.  Now, whenever I push a new change back to GitHub the snap will get rebuilt <strong>automatically</strong> and uploaded to the store! All I would need to do is a snap refresh and I&#8217;d be upgraded to the latest version. All my requirements solved in one place.</p>



<h2>How to use the snap</h2>



<p>If your Pi is running snapd, it&#8217;s dead easy (e.g. Ubuntu MATE or Ubuntu Core):</p>



<pre class="wp-block-preformatted">sudo snap install cloudflaredoh --edge</pre>



<p>The snap is currently in the edge channel, meaning it&#8217;s not ready for the main stage just yet.  Once I&#8217;ve spent a bit more time on it, I will move it to stable.</p>



<pre class="wp-block-preformatted">sudo snap set cloudflaredoh address=127.0.0.1<br>sudo snap set cloudflaredoh port=5053</pre>



<p>Configure proxy-dns to listen on 127.0.0.1.  If you want it to answer DNS queries from other computers on your network try either the IP address of the box, or just 0.0.0.0 to listen on all interfaces.  It will also configure proxy-dns to listen on port 5053.  If you want it to answer DNS queries from other computers on your network, use the default DNS port of 53.</p>



<pre class="wp-block-preformatted">sudo snap get cloudflaredoh</pre>



<p>This will show you the currently set config options.</p>



<pre class="wp-block-preformatted">sudo snap restart cloudflaredoh</pre>



<p>Restart proxy-dns and use the new config.</p>



<p>Now you can use something like nslookup to query the DNS server and make sure it&#8217;s doing what you expected.</p>



<h2>10 Steps To DNS-over-HTTPS</h2>



<ol>
<li>Get a Raspberry Pi</li>
<li>Download Ubuntu Core and write it to an SD card</li>
<li>Put the SD card in your Pi and boot it</li>
<li>Set up the network on Ubuntu Core (tip: register for an <a href="https://login.ubuntu.com/+login">Ubuntu One</a> account first)</li>
<li>sudo snap install cloudflaredoh</li>
<li>sudo snap set cloudflaredoh address=0.0.0.0</li>
<li>sudo snap set cloudflaredoh port=53</li>
<li>sudo snap restart cloudflaredoh</li>
<li>Configure your client&#8217;s DNS server as the IP address of your Pi</li>
<li>Have a cup of tea</li>
</ol>



<h2>Update 2019-08-01</h2>



<p>I&#8217;ve got a new Github repo set up with an improved snapcraft.yaml which pulls directly from the upstream project.  I&#8217;m aiming to get this hooked up to the Snapcraft build service so that we can package the latest version automatically.  More on this later.  In the meantime, you can clone this and build the latest version yourself:</p>



<p><a href="https://github.com/8none1/cloudflarednsproxy">https://github.com/8none1/cloudflarednsproxy</a></p>
        <div class="clearfix"></div>
          
       
    </section>
            <footer class="entry-footer">
                    <div class="meta">
					<span class="author">Posted by </span><a href="/author/will/" title="Posts by will" rel="author">will</a>                <span class="seporator">/</span>
                <span class="date-post h6">July 16, 2019</span>
                                                                                                                                                                                            <span class="seporator">/</span>
                        <span>Posted in</span>
                        <a href="/category/iot/" rel="category tag">IoT</a><span>,</span> <a href="/category/linux/" rel="category tag">linux</a><span>,</span> <a href="/category/raspberrypi/" rel="category tag">RaspberryPi</a><span>,</span> <a href="/category/ubuntu-2/" rel="category tag">Ubuntu</a><span>,</span> <a href="/category/uncategorized/" rel="category tag">Uncategorized</a>                                                                </div>
            </footer>
    </article><!-- #post -->                                                <nav class="navigation paging-navigation">
                                    </nav><!-- .navigation -->

            
        </div>
        <div class=" col-xs-12 col-sm-12 col-md-4 col-lg-4">
            <aside id="sidebar">
    <div class="widget-area">
                    <div id="archives-4" class="widget widget_archive">
<h3 class="widget-title">Archives</h3>
			<ul>
					<li><a href="/2021/07/">July 2021</a></li>
	<li><a href="/2021/01/">January 2021</a></li>
	<li><a href="/2019/07/" aria-current="page">July 2019</a></li>
	<li><a href="/2019/06/">June 2019</a></li>
	<li><a href="/2019/05/">May 2019</a></li>
	<li><a href="/2017/05/">May 2017</a></li>
	<li><a href="/2017/03/">March 2017</a></li>
	<li><a href="/2017/02/">February 2017</a></li>
	<li><a href="/2016/12/">December 2016</a></li>
	<li><a href="/2016/11/">November 2016</a></li>
	<li><a href="/2016/10/">October 2016</a></li>
	<li><a href="/2016/09/">September 2016</a></li>
	<li><a href="/2016/02/">February 2016</a></li>
	<li><a href="/2015/12/">December 2015</a></li>
	<li><a href="/2015/10/">October 2015</a></li>
	<li><a href="/2015/09/">September 2015</a></li>
	<li><a href="/2015/06/">June 2015</a></li>
	<li><a href="/2015/05/">May 2015</a></li>
	<li><a href="/2015/02/">February 2015</a></li>
	<li><a href="/2014/08/">August 2014</a></li>
	<li><a href="/2014/02/">February 2014</a></li>
	<li><a href="/2014/01/">January 2014</a></li>
	<li><a href="/2013/12/">December 2013</a></li>
	<li><a href="/2013/11/">November 2013</a></li>
	<li><a href="/2013/02/">February 2013</a></li>
	<li><a href="/2012/11/">November 2012</a></li>
	<li><a href="/2012/08/">August 2012</a></li>
	<li><a href="/2012/03/">March 2012</a></li>
	<li><a href="/2011/09/">September 2011</a></li>
	<li><a href="/2011/08/">August 2011</a></li>
	<li><a href="/2011/07/">July 2011</a></li>
	<li><a href="/2011/06/">June 2011</a></li>
	<li><a href="/2011/04/">April 2011</a></li>
	<li><a href="/2011/02/">February 2011</a></li>
	<li><a href="/2010/10/">October 2010</a></li>
	<li><a href="/2010/09/">September 2010</a></li>
	<li><a href="/2010/08/">August 2010</a></li>
	<li><a href="/2010/06/">June 2010</a></li>
	<li><a href="/2010/01/">January 2010</a></li>
	<li><a href="/2009/10/">October 2009</a></li>
	<li><a href="/2009/09/">September 2009</a></li>
	<li><a href="/2009/08/">August 2009</a></li>
	<li><a href="/2009/07/">July 2009</a></li>
	<li><a href="/2009/06/">June 2009</a></li>
	<li><a href="/2009/05/">May 2009</a></li>
			</ul>

			</div>
		<div id="recent-posts-2" class="widget widget_recent_entries">
		<h3 class="widget-title">Recent Posts</h3>
		<ul>
											<li>
					<a href="/2021/07/14/finally-moving-to-a-static-site/">Finally moving to a static site</a>
									</li>
											<li>
					<a href="/2021/01/02/double-helping-of-pi-hole/">Double helping of Pi Hole</a>
									</li>
											<li>
					<a href="/2019/07/16/dns-over-https-in-a-snap/">DNS over HTTPS in a snap</a>
									</li>
											<li>
					<a href="/2019/06/11/whizzy-labs-wireless-sensor/">Whizzy Labs Wireless Sensor</a>
									</li>
											<li>
					<a href="/2019/05/07/ubuntu-developer-desktop-survey-2019/">Ubuntu Developer Desktop Survey 2019</a>
									</li>
					</ul>

		</div>
<div id="categories-4" class="widget widget_categories">
<h3 class="widget-title">Categories</h3>
			<ul>
					<li class="cat-item cat-item-2">
<a href="/category/alexa/">Alexa</a>
</li>
	<li class="cat-item cat-item-3">
<a href="/category/arduino/">Arduino</a>
</li>
	<li class="cat-item cat-item-4">
<a href="/category/asterisk/">asterisk</a>
</li>
	<li class="cat-item cat-item-5">
<a href="/category/google-maps/">Google Maps</a>
</li>
	<li class="cat-item cat-item-6">
<a href="/category/iot/">IoT</a>
</li>
	<li class="cat-item cat-item-7">
<a href="/category/javascript/">Javascript</a>
</li>
	<li class="cat-item cat-item-8">
<a href="/category/linux/">linux</a>
</li>
	<li class="cat-item cat-item-9">
<a href="/category/making-the-world-a-better-place/">Making the world a better place</a>
</li>
	<li class="cat-item cat-item-10">
<a href="/category/raspberrypi/">RaspberryPi</a>
</li>
	<li class="cat-item cat-item-12">
<a href="/category/so-called-humor/">So called humor</a>
</li>
	<li class="cat-item cat-item-13">
<a href="/category/tv/">tv</a>
</li>
	<li class="cat-item cat-item-14">
<a href="/category/ubuntu-2/">Ubuntu</a>
</li>
	<li class="cat-item cat-item-15">
<a href="/category/uncategorized/">Uncategorized</a>
</li>
			</ul>

			</div>            </div>
<!-- .widget-area -->
</aside>
        </div>
    </div>
</div>

</div>
<!-- #main -->
	<footer id="footer" class="site-footer">
		<a href="#" id="toTop" class="toTop"><i class="fa fa-angle-up"></i></a>
		<div class="footer-sidebar">
    <div class="container">
        <div class="row">            
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
        </div>
<!-- .widget-area -->
    </div>
</div>		<div class="footer-inner">
			<div class="container">
								<p class="social-profile type1 pull-right">
																<a href="https://twitter.com/8none1" class="button-twitter" title="Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a>
																					<a href="https://github.com/8none1" class="button-google" title="Google +" target="_blank"><i class="fa fa-google-plus-square"></i></a>
																															<a href="https://www.youtube.com/user/willcooke1" class="button-youtube" title="Youtube" target="_blank"><i class="fa fa-youtube-square"></i></a>
															                    
				</p>
				<p class="copyright"><span class="copyright-date">
						&copy; Copyright 2021                    </span>
										  <a href="/" title="whizzy.org" target="_blank">whizzy.org</a>
					  &#8226; Designed by <a href="https://motopress.com/" rel="nofollow" title="Premium WordPress Plugins and Themes">MotoPress</a>
					  &#8226; Proudly Powered by <a href="http://wordpress.org/" rel="nofollow" title="Semantic Personal Publishing Platform">WordPress</a>
					  				</p>
<!-- .copyright -->
			</div>
		</div>
	</footer>
</div>
<script type="text/javascript" src="/wp-includes/js/hoverIntent.min.js?ver=1.8.1" id="hoverIntent-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/superfish.min.js?ver=1.7.5" id="superfish.min-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/jquery.flexslider-min.js?ver=2.5.0" id="flexslider-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/jquery.appear.min.js?ver=0.3.6" id="jquery.appear-js"></script>
<script type="text/javascript" id="emmet-script-js-extra">
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
var template_directory_uri = {"url":"\/wp-content\/themes\/emmet-lite"};
/* ]]> */
</script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/emmet.min.js?ver=1.7.5" id="emmet-script-js"></script>
<script type="text/javascript" src="/wp-includes/js/wp-embed.min.js?ver=5.7.2" id="wp-embed-js"></script>
    <script>
        /(trident|msie)/i.test(navigator.userAgent)&&document.getElementById&&window.addEventListener&&window.addEventListener("hashchange",function(){var t,e=location.hash.substring(1);/^[A-z0-9_-]+$/.test(e)&&(t=document.getElementById(e))&&(/^(?:a|select|input|button|textarea)$/i.test(t.tagName)||(t.tabIndex=-1),t.focus())},!1);
    </script>
	</body>
</html>