<!DOCTYPE html>
<html lang="en-GB">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="/xmlrpc.php">
	<title>Making the world a better place &#8211; Page 3 &#8211; whizzy.org</title>
<meta name="robots" content="max-image-preview:large">
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//s.w.org">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Feed" href="/feed/">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Comments Feed" href="/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="whizzy.org &raquo; Making the world a better place Category Feed" href="/category/making-the-world-a-better-place/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/13.0.1\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.7.2"}};
			!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode;p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0);e=i.toDataURL();return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(!p||!p.fillText)return!1;switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([55357,56424,8205,55356,57212],[55357,56424,8203,55356,57212])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(n=t.source||{}).concatemoji?c(n.concatemoji):n.wpemoji&&n.twemoji&&(c(n.twemoji),c(n.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}</style>
	<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=5.7.2" type="text/css" media="all">
<link rel="stylesheet" id="googleOpenSans-css" href="//fonts.googleapis.com/css?family=Open+Sans%3A400%2C400italic%2C600%2C700%2C700italic&#038;subset=latin%2Ccyrillic&#038;ver=5.7.2" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="/wp-content/themes/emmet-lite/css/bootstrap.min.css?ver=3.3.5" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="/wp-content/themes/emmet-lite/css/font-awesome.min.css?ver=4.7.0" type="text/css" media="all">
<link rel="stylesheet" id="flexslider-css" href="/wp-content/themes/emmet-lite/css/flexslider.min.css?ver=2.5.0" type="text/css" media="all">
<link rel="stylesheet" id="emmet-main-css" href="/wp-content/themes/emmet-lite/css/emmet-style.min.css?ver=1.7.5" type="text/css" media="all">
<link rel="stylesheet" id="emmet-style-css" href="/wp-content/themes/emmet-lite/style.css?ver=1.7.5" type="text/css" media="all">
<script type="text/javascript" src="/wp-includes/js/jquery/jquery.min.js?ver=3.5.1" id="jquery-core-js"></script>
<script type="text/javascript" src="/wp-includes/js/jquery/jquery-migrate.min.js?ver=3.3.2" id="jquery-migrate-js"></script>
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/categories/9">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 5.7.2">
    <style type="text/css" id="theme-header-css">.welcome-right {
            background: url("/wp-content/themes/emmet-lite/images/welcome-image.png") no-repeat scroll left center rgba(0, 0, 0, 0);
        }

                        .third-left {
            background: url("/wp-content/themes/emmet-lite/images/third-image.png") no-repeat scroll right center rgba(0, 0, 0, 0);
        }</style>
    <style type="text/css" id="custom-background-css">body.custom-background { background-image: url("/wp-content/themes/emmet-lite/images/main-bg.jpg"); background-position: center top; background-size: auto; background-repeat: no-repeat; background-attachment: fixed; }</style>
	</head>
<body class="archive paged category category-making-the-world-a-better-place category-9 custom-background paged-3 category-paged-3 emmet pages-background">
<a class="skip-link screen-reader-text" href="#main">
	Skip to content</a>
<div class="wrapper  ">
				<header id="header" class="main-header">
							<div class="top-header">
					<div class="container">
												<div class="top-menu">
							<ul id="menu-top-menu" class="menu"></ul>							<div class="clearfix"></div>
						</div>

						<div class="social-profile type1 ">
																						<a href="https://twitter.com/8none1" class="button-twitter" title="Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a>
																													<a href="https://github.com/8none1" class="button-google" title="Google +" target="_blank"><i class="fa fa-google-plus-square"></i></a>
																																											<a href="https://www.youtube.com/user/willcooke1" class="button-youtube" title="Youtube" target="_blank"><i class="fa fa-youtube-square"></i></a>
																					                            						</div>
						<div class="contact-info ">
							<ul class=" info-list">
																																																									</ul>
							<div class="clearfix"></div>
						</div>
					</div>
				</div>
							<div class="site-header" data-sticky-menu="off">
				<div class="container">
					<div class="site-logo">
													<a class="home-link" href="/" title="whizzy.org" rel="home">
                                											<div class="site-description">
									<p class="site-title ">whizzy.org</p>
																			<p class="site-tagline">On code and gadgets.</p>
																	</div>
							</a>
											</div>
                    <button class="menu-toggle" aria-controls="main-menu" aria-expanded="false"><span class="menu-show">Menu</span>
                        <span class="menu-close">Close</span>
                        
                    </button>
					<div id="navbar" class="navbar">
						<nav id="site-navigation" class="main-navigation">
							<ul class="sf-menu"></ul>						</nav>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>
		</header>
		<div id="main" class="site-main">
    <div class="container breadcrumb-wrapper">
        <div class="breadcrumb breadcrumbs sp-breadcrumbs"><div class="breadcrumb-trail">
<a href="/" title="whizzy.org" rel="home" class="trail-begin">Home</a> <span class="sep"><i class="fa fa-angle-right"></i></span> <span class="trail-end">Making the world a better place</span>
</div></div>    </div>
<div class="container main-container">
    <div class="row clearfix">
        <div class=" col-xs-12 col-sm-12 col-md-8 col-lg-8">
                         
                                                    <article id="post-684" class="post-in-blog post post-684 type-post status-publish format-standard hentry category-arduino category-iot category-making-the-world-a-better-place">
                    <header class="entry-header">
        <h2 class="entry-title">
            <a href="/2015/10/20/hacking-433mhz-support-into-a-cheap-carbon-monoxide-detector/" rel="bookmark">Hacking 433Mhz support into a cheap Carbon Monoxide detector</a>
        </h2>
    </header> 
    <section class="entry entry-content">
        <p><strong>Skill level:  Easy</strong></p>
<p>My home automation systems use two mechanisms for communication:  Ethernet (both wired and wireless) and 433MHz OOK radio.</p>
<p>433MHz transmitters are readily available and are cheap but unreliable.  Wifi enabled MCUs such as the ESP8266 are also cheap (coming in at around the same cost as an Arduino clone, a 433MHz transmitter and a bag of bits to connect them together), they are reliable enough but extremely power hungry.  If I can plug a project into the mains then I&#8217;ll use an ESP8266 and a mobile phone charger for power, if the project needs to run off batteries then a 433MHz equipped Arduino is the way I&#8217;ve gone.</p>
<p>Like most people playing with 433MHz radio I found reliability and range of the radio link to be super flaky.  I&#8217;ve finally got a more-or-less reliable set-up:</p>
<ul>
<li>A full wave dipole antenna at the receiver</li>
<li>A high quality receiver from RF Solutions in place of the cheap ones which are bundled with transmitters. <a href="http://rover.ebay.com/rover/1/710-53481-19255-0/1?icep_ff3=2&amp;pub=5575128401&amp;toolid=10001&amp;campid=5337704861&amp;customid=&amp;icep_item=231721857012&amp;ipn=psmain&amp;icep_vectorid=229508&amp;kwid=902099&amp;mtid=824&amp;kw=lg" target="_blank" rel="noopener noreferrer">A decent receiver on eBay</a>
</li>
<li>A big capacitor on the transmitter.  I saw the frequency and amplitude drifting massively during transmission.  Adding a 470µF cap helps.  Allow time for the cap to charge and the oscillator to stabilise, a few seconds delay seemed to do the trick.</li>
<li>Using the RCSwitch library on the transmitter:
<ul>
<li>
<pre>RCSwitch mySwitch = RCSwitch();</pre>
</li>
<li>
<pre>mySwitch.setProtocol(2); // Much longer pulse lengths = much better range?</pre>
</li>
<li>
<pre>mySwitch.setRepeatTransmit(20); // Just brute-force it!</pre>
</li>
</ul>
</li>
</ul>
<p>With this setup I can get receive a 24bit number from an Arduino running off 2 AA batteries and a coiled 1/2 wave antenna from about 5 meters indoors through walls.  That&#8217;s still poor, but it does the job.  Increasing the voltage to the transmitter would probably help.</p>
<p>Once you have a reliable 433MHz receiver setup then you can also buy off the shelf 433MHz enabled home automation gizmos like <a href="http://rover.ebay.com/rover/1/710-53481-19255-0/1?icep_ff3=2&amp;pub=5575128401&amp;toolid=10001&amp;campid=5337704861&amp;customid=&amp;icep_item=181665729292&amp;ipn=psmain&amp;icep_vectorid=229508&amp;kwid=902099&amp;mtid=824&amp;kw=lg" target="_blank" rel="noopener noreferrer">this smoke alarm</a> or <a href="http://rover.ebay.com/rover/1/710-53481-19255-0/1?icep_ff3=2&amp;pub=5575128401&amp;toolid=10001&amp;campid=5337704861&amp;customid=&amp;icep_item=281405424486&amp;ipn=psmain&amp;icep_vectorid=229508&amp;kwid=902099&amp;mtid=824&amp;kw=lg" target="_blank" rel="noopener noreferrer">these door sensors</a>.  They have a set of jumpers inside where you can set an ID, which is essentially the same 24bit number that RCSwitch lets you transmit.  For what it&#8217;s worth I also have <a href="https://en.wikipedia.org/wiki/British_Standards" target="_blank" rel="noopener noreferrer">kite-marked</a> smoke detectors in my house, but from the testing I&#8217;ve done with a bit of smoldering paper the cheap imports work just fine.</p>
<p>I couldn&#8217;t find a cheap Carbon Monoxide which also has 433MHz support so I thought I&#8217;d quickly hack one together out of <a href="http://rover.ebay.com/rover/1/710-53481-19255-0/1?icep_ff3=2&amp;pub=5575128401&amp;toolid=10001&amp;campid=5337704861&amp;customid=&amp;icep_item=281723682194&amp;ipn=psmain&amp;icep_vectorid=229508&amp;kwid=902099&amp;mtid=824&amp;kw=lg" target="_blank" rel="noopener noreferrer">this Carbon Monoxide detector</a> and an Arduino clone and 433MHz radio:</p>
<p><a href="http://whizzy.org/wp-content/uploads/2015/10/IMG_1237.jpg"><img loading="lazy" class="alignleft size-medium wp-image-703" src="/wp-content/uploads/2015/10/IMG_1237-225x300.jpg" alt="CO Alarm inside" width="225" height="300" srcset="/wp-content/uploads/2015/10/IMG_1237-225x300.jpg 225w, /wp-content/uploads/2015/10/IMG_1237-768x1024.jpg 768w, /wp-content/uploads/2015/10/IMG_1237-1152x1536.jpg 1152w, /wp-content/uploads/2015/10/IMG_1237-1536x2048.jpg 1536w, /wp-content/uploads/2015/10/IMG_1237-1200x1600.jpg 1200w, /wp-content/uploads/2015/10/IMG_1237-1980x2640.jpg 1980w, /wp-content/uploads/2015/10/IMG_1237-scaled.jpg 1920w" sizes="(max-width: 225px) 100vw, 225px"></a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div id="attachment_706" style="width: 310px" class="wp-caption alignleft">
<a href="http://whizzy.org/wp-content/uploads/2015/10/IMG_1238.jpg"><img aria-describedby="caption-attachment-706" loading="lazy" class="wp-image-706 size-medium" src="/wp-content/uploads/2015/10/IMG_1238-300x225.jpg" alt="IMG_1238" width="300" height="225" srcset="/wp-content/uploads/2015/10/IMG_1238-300x225.jpg 300w, /wp-content/uploads/2015/10/IMG_1238-1024x768.jpg 1024w, /wp-content/uploads/2015/10/IMG_1238-768x576.jpg 768w, /wp-content/uploads/2015/10/IMG_1238-1536x1152.jpg 1536w, /wp-content/uploads/2015/10/IMG_1238-2048x1536.jpg 2048w, /wp-content/uploads/2015/10/IMG_1238-1200x900.jpg 1200w, /wp-content/uploads/2015/10/IMG_1238-1980x1485.jpg 1980w" sizes="(max-width: 300px) 100vw, 300px"></a><p id="caption-attachment-706" class="wp-caption-text">You can barely notice it!</p>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>It&#8217;s certainly untidy, but it does the job.  If I had PCB facilities at home I&#8217;m fairly sure it could be made to fit inside the alarm, along with some more holes in the case for ventilation.</p>
<p>The premise is simple enough.  The Arduino is powered by the 3v3 regulator on the CO alarm PCB.  The cathode of the red alarm LED is connected to pin 2 of the Arduino as an external interrupt.  When the pin goes low the Arduino wakes up and sends it&#8217;s 24bit ID number over the radio which is picked up by the receiver which sends an SMS alert, switches the boiler off, etc.  I&#8217;ve connected the radio transmitter to directly to the 3 x AA batteries (4.5 volts) via a transistor which is switched by a pin on the Arduino.  In standy-by mode the additional equipment draws a fraction of a milliamp and so I&#8217;m not worried about draining the batteries faster.</p>
<p>As with the smoke alarms, this is not my only source of Carbon Monoxide detection.  I&#8217;ve yet to test it&#8217;s sensitivity.  This is considered to be a &#8220;well, if it works, and it turns the boiler off automatically then it&#8217;s certainly worth a go, but I&#8217;m not relying on it&#8221; project.</p>
        <div class="clearfix"></div>
          
       
    </section>
            <footer class="entry-footer">
                    <div class="meta">
					<span class="author">Posted by </span><a href="/author/will/" title="Posts by will" rel="author">will</a>                <span class="seporator">/</span>
                <span class="date-post h6">October 20, 2015</span>
                                                                                                                                                                                            <span class="seporator">/</span>
                        <span>Posted in</span>
                        <a href="/category/arduino/" rel="category tag">Arduino</a><span>,</span> <a href="/category/iot/" rel="category tag">IoT</a><span>,</span> <a href="/category/making-the-world-a-better-place/" rel="category tag">Making the world a better place</a>                                                                </div>
            </footer>
    </article><!-- #post -->                                    <article id="post-598" class="post-in-blog post post-598 type-post status-publish format-standard hentry category-linux category-making-the-world-a-better-place category-raspberrypi category-ubuntu-2">
                    <header class="entry-header">
        <h2 class="entry-title">
            <a href="/2015/02/04/snapping-mosquitto-mqtt-broker/" rel="bookmark">Snapping Mosquitto MQTT broker</a>
        </h2>
    </header> 
    <section class="entry entry-content">
        <p style="text-align: justify;"><em>As part of my ever expanding home automation system I wanted to use MQTT to publish data on my network. With the release of the Raspberry Pi 2 I can run Ubuntu Core to create a reliable, secure and easily updated server which is a perfect fit for requirements of an MQTT broker and general HA controller. I asked some Ubuntu friends to help me package Mosquitto as a Snap, and in return I would write down how we did it. Here&#8217;s the story&#8230;</em></p>
<p>Start by reading this: <a title="https://developer.ubuntu.com/en/snappy/" href="https://developer.ubuntu.com/en/snappy/">https://developer.ubuntu.com/en/snappy/</a></p>
<p style="text-align: justify;"><span style="text-decoration: underline;">In summary;</span> a Snappy application is secure because it&#8217;s wrapped with AppArmor. It&#8217;s easier to install and upgrade because everything is packaged in a single file and installed to a single location. That location is backed-up before you install a new version, and so if the installation goes wrong you can revert to the previous version easily by copying the original files back (or rather, Snappy will do all of that for you). Simplifying things slightly there are two types of Snappy &#8220;application&#8221;: Apps and Frameworks. Frameworks can extend the OS and provide a mediation layer to access shared resources. Apps are your more traditional top-level items which can use the provided frameworks, or bundle everything they need in to their Snap. This makes things much easier for app providers because they are now in charge &#8211; they can be assured that no library will change underneath them.  This is a huge benefit!</p>
<h2>Let&#8217;s get Mosquitto snapped.</h2>
<h3>1. Install QEMU to run an Ubuntu Core machine</h3>
<p><a title="http://www.ubuntu.com/cloud/tools/snappy#snappy-local" href="http://www.ubuntu.com/cloud/tools/snappy#snappy-local">http://www.ubuntu.com/cloud/tools/snappy#snappy-local</a></p>
<p>First we install the KVM hypervisor:</p>
<pre style="padding-left: 60px;">sudo apt-get install qemu-kvm</pre>
<p>Then check everything is as it should be with:</p>
<pre style="padding-left: 60px;">kvm-ok</pre>
<p>Now download the latest Ubuntu Core image from here: <a title="http://cdimage.ubuntu.com/ubuntu-core/preview/" href="http://cdimage.ubuntu.com/ubuntu-core/preview/">http://cdimage.ubuntu.com/ubuntu-core/preview/</a>  At the time of writing this is the newest x86-64 image: <a title="http://cdimage.ubuntu.com/ubuntu-core/preview/ubuntu-core-alpha-02_amd64-virt.img" href="http://cdimage.ubuntu.com/ubuntu-core/preview/ubuntu-core-alpha-02_amd64-virt.img">http://cdimage.ubuntu.com/ubuntu-core/preview/ubuntu-core-alpha-02_amd64-virt.img</a></p>
<p>Then launch the virtual machine. This command port forwards 8022 on your local machine to 22 on the virtual machine, so you can SSH to port 8022 on localhost and actually connect to the Ubuntu Core machine. It gives the Core machine 512MB of RAM, nicely achievable on a modest budget (The Pi2 has 1 GB).  We also forward port 1883 from to the VM, which will allow us to connect to the Mosquitto server on our VM once it&#8217;s all installed.</p>
<pre style="padding-left: 60px;">kvm -m 512 -redir :8022::22 -redir :1883::1883 &lt;vm image file&gt;</pre>
<p>Once it&#8217;s booted you can connect to it with SSH. The username and password are &#8220;ubuntu&#8221;.</p>
<pre style="padding-left: 60px;">ssh -p 8022 ubuntu@localhost</pre>
<p>To make things a bit easier, why not use key authentication? On your host machine:</p>
<pre style="padding-left: 60px;">ssh-copy-id -p 8022 ubuntu@localhost</pre>
<p>We should also upgrade our Ubuntu Core VM before we start.  SSH in to your box and run:</p>
<pre style="padding-left: 60px;">sudo snappy update
sudo reboot</pre>
<h3>2. Build Mosquitto in the right way</h3>
<p>Back on your host (not the virtual machine you just created above) create some directories to hold the code and download the latest stable source and the build dependencies for Mosquitto:</p>
<pre style="padding-left: 60px;">sudo apt-get install build-essential cmake
sudo apt-get build-dep mosquitto</pre>
<pre style="padding-left: 60px;">mkdir -p mosquitto/install mosquitto/build</pre>
<pre style="padding-left: 60px;">cd mosquitto</pre>
<pre style="padding-left: 60px;">wget http://mosquitto.org/files/source/mosquitto-1.3.5.tar.gz</pre>
<pre style="padding-left: 60px;">tar xvzf mosquitto-1.3.5.tar.gz</pre>
<pre style="padding-left: 60px;">cd build</pre>
<p>Time to build Mosquitto.  Before you run the commands below, a bit of background information.  The cmake line will force cmake to install the binaries to the location specified with INSTALL_PREFIX, rather than /usr/local.  This is required to bundle all of the binaries and other files to the &#8220;install&#8221; directory we created above, making it possible to package as a Snappy.</p>
<pre style="padding-left: 60px;">cmake -DCMAKE_INSTALL_PREFIX=`readlink -f ../install/` ../mosquitto-1.3.5</pre>
<pre style="padding-left: 60px;">make -j`nproc`

make install</pre>
<p>nproc spits out the number of processor cores you have, so the make line above will use as many processor cores as you have available.  It&#8217;s not required, and for Mosquitto which is fairly small it&#8217;s not worth worrying about, but for a bigger job this is quite handy.</p>
<p>If you look in the &#8220;../install&#8221; directory you&#8217;ll see a familiar structure containing all the goodies needed by Mosquitto.</p>
<h3>3. Find the libraries needed and copy them in to your Snappy project</h3>
<p>Change in to the install/lib directory and use ldd to display the linked libraries for the two main .so files:</p>
<pre style="padding-left: 60px;">ldd lib/libmosquitto.so.1.3.5 lib/libmosquittopp.so.1.3.5 | grep '=&gt;' | awk '{ print $1 }' | sort | uniq</pre>
<p>This uses ldd to show the libraries required by Mosquitto, and then sorts them in to a nice list. You&#8217;ll see something like this:</p>
<pre style="padding-left: 60px;">libcares.so.2
libcrypto.so.1.0.0
libc.so.6
libdl.so.2
libgcc_s.so.1
libmosquitto.so.1
libm.so.6
libpthread.so.0
librt.so.1
libssl.so.1.0.0
libstdc++.so.6
linux-vdso.so.1</pre>
<p>Now, on the Ubuntu Core machine we can run this little script:</p>
<pre style="padding-left: 60px;">for i in `cat`; do find /lib /usr/lib -name $i; done</pre>
<p>Copy the list from the previous command to the clipboard and then paste it in to terminal where this command is running and hit Ctrl-D to submit the list.  The script will then search Ubuntu Core for the libraries required.  If it finds them they will be displayed, if it doesn&#8217;t then they are not available in Ubuntu Core by default and will need to be included in your Snappy package.</p>
<p><code>linux-vdso</code> is the Linux kernel and is available on every Linux system by default, so we don&#8217;t need to provide that specifically.</p>
<p><code>libssl, libcrypto, libpthread, librt, libc </code>and<code> libdl</code> are all available in Ubuntu Core by default &#8211; so we don&#8217;t need those either.</p>
<p>That leaves just <code>libcares</code> to be copied in to our package.</p>
<pre style="padding-left: 60px;"> cp /usr/lib/x86_64-linux-gnu/libcares.so.2.1.0 .</pre>
<p>We should already be in the &#8216;lib&#8217; directory, hence the &#8216;.&#8217; above.  We are copying libcares in to the lib directory of our Snap, and when we run the Snap we will pass in the library path to make sure Mosquitto can find it.  More on this later.</p>
<h3>4. Add the meta data required for the Snappy package</h3>
<p>Reference: <a title=" https://developer.ubuntu.com/en/snappy/guides/packaging-format-apps/" href="https://developer.ubuntu.com/en/snappy/guides/packaging-format-apps/">https://developer.ubuntu.com/en/snappy/guides/packaging-format-apps/</a></p>
<p>Create the meta data directory inside the install directory (change to the install directory, it should just be cd ..):</p>
<pre style="padding-left: 60px;">mkdir meta</pre>
<p>Create the package.yaml file:</p>
<pre style="padding-left: 60px;">nano meta/package.yaml</pre>
<p>And this is what we&#8217;re putting in it:</p>
<pre style="padding-left: 60px;">name: mosquitto.willcooke
architecture: amd64
version: 1.3.5
icon:
services:
 - name: mosquitto
 start: ./sbin/mosquitto.sh
ports:
 required: 1883</pre>
<p>Information about these fields and what they mean is available in the reference linked to above, but they are easily understandable.  A comment on the name though, you need to append .&lt;yournamespace&gt; where your namespace is as you select in your Ubuntu myapps account.  One thing to mention, you can see that to start our Snap we are calling a shell script.  This allows us to pass in extra options to Mosquitto when it runs.</p>
<p>Next we need to create a readme file:</p>
<pre style="padding-left: 60px;">nano meta/readme.md</pre>
<p>This file needs to contain at least a couple of non-blank lines.  Here&#8217;s what we put in it:</p>
<pre style="padding-left: 60px;">This is a Snappy package for Mosquitto MQTT broker.</pre>
<pre style="padding-left: 60px;">Information about Mosquitto is available here:  http://mosquitto.org/</pre>
<pre style="padding-left: 60px;">Information about MQTT is available here: http://mqtt.org/</pre>
<p>We also need to configure our Mosquitto server, by editing the conf file.  Most of the settings can be left as default, so we will create a new conf file with only the bits in we need.</p>
<pre style="padding-left: 60px;">mv etc/mosquitto/mosquitto.conf etc/mosquitto/mosquitto.conf.ori</pre>
<pre style="padding-left: 60px;">nano etc/mosquitto/mosquitto.conf</pre>
<p>Add these two lines:</p>
<pre style="padding-left: 60px;">user root
persistence_location /var/apps/mosquitto/current/</pre>
<p>We need to change this to run as root.  Since our Snap will be confined there is no risk here.  I expect the ability to run as non-root users when using Snappy will be improved, but really it&#8217;s not necessary.</p>
<p>We also need to add a small shell script to start Mosquitto with the right options.  Create a file in install/sbin called mosquitto.sh:</p>
<pre style="padding-left: 60px;">nano sbin/mosquitto.sh</pre>
<p>And add this:</p>
<pre style="padding-left: 30px;">#!/bin/sh
LD_LIBRARY_PATH=./lib:$LD_LIBRARY_PATH exec ./sbin/mosquitto -c etc/mosquitto/mosquitto.conf</pre>
<p>We are specifying where to find the extra libraries we require and where to find the conf file.  Make that file executable:</p>
<pre style="padding-left: 60px;">chmod +x sbin/mosquitto.sh</pre>
<h3>5. Build your Snappy package</h3>
<p>Add the Snappy PPA to get the build tools, and then install them:</p>
<pre style="padding-left: 60px;">sudo add-apt-repository ppa:snappy-dev/beta
sudo apt-get update
sudo apt-get dist-upgrade
sudo apt install snappy-tools</pre>
<p>In your <code>install</code> directory run:</p>
<pre style="padding-left: 60px;">snappy build .</pre>
<p>If you see an error about ImportError: No module named &#8216;click.repository&#8217; then you likely have a clash between the Click library version in the SDK team PPA and the version in the Snappy PPA.  This will be fixed soon, but in the meantime I would suggest installing ppa-purge via apt-get and then running <code>sudo ppa-purge ppa:ubuntu-sdk-team/ppa</code>.</p>
<p>If you see an error about &#8220;expected &lt;block end&gt;&#8221; in the package.yaml check the whitespace in the file.  It&#8217;s likely a copy and paste error.</p>
<h3>6. Install your Snappy package</h3>
<p>Once you have your .snap file you can install it to your virtual machine like this:</p>
<pre>snappy-remote --url=ssh://localhost:8022 install ./mosquitto_1.3.5_amd64.snap</pre>
<p>&nbsp;</p>
<h3>7. Test your Snappy package</h3>
<p>If everything has gone to plan Mosquitto should now be running on your virtual machine.  In order to test you&#8217;ll need to write a test Publisher and Subscriber.  I used the Python Paho library.</p>
<p>Here&#8217;s an example Publisher:</p>
<pre style="padding-left: 60px;">#!/usr/bin/python</pre>
<pre style="padding-left: 60px;">import paho.mqtt.client as mqtt
from datetime import datetime
from time import sleep</pre>
<pre style="padding-left: 60px;">def send_mqtt(topic, message):
 log("Sending MQTT")
 log("Topic: "+topic)
 log("Message: "+message)
 mqttc.reconnect()
 mqttc.publish(topic, message)
 mqttc.loop() 
 mqttc.disconnect()</pre>
<pre style="padding-left: 60px;">print "Time server starting up...."
mqttc = mqtt.Client("python_pub")
mqttc.connect("localhost", 1883)</pre>
<pre style="padding-left: 60px;">while True:
 tstr = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
 send_mqtt("/information/time",tstr)
 sleep(10)</pre>
<p>And here&#8217;s an example Subscriber:</p>
<pre style="padding-left: 60px;">#!/usr/bin/python</pre>
<pre style="padding-left: 60px;">import paho.mqtt.client as mqtt
import datetime</pre>
<pre style="padding-left: 60px;">def on_connect(client, userdata, rc):
 print "Connected with result code "+str(rc)
 client.subscribe("#")
 
def on_message(client, userdata, msg):
 print "Topic: ", msg.topic+'\nMessage: '+str(msg.payload)
 
 
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message</pre>
<pre style="padding-left: 60px;">client.connect("localhost", 1883, 60)</pre>
<pre style="padding-left: 60px;">client.loop_forever()</pre>
<p>&nbsp;</p>
<h2>What&#8217;s next?</h2>
<p>We&#8217;ve built a Snappy package for amd64 (or whatever your native architecture is), but we really need to be cross-architecture to give people the best choice of platform on which to use the package.  This involves cross compiling, which can be tricky to put it mildly.</p>
<p>I spoke to <a title="https://plus.google.com/+AlexanderSack/posts" href="https://plus.google.com/+AlexanderSack/posts">Alexander Sack</a>, the Director of Ubuntu Core, and asked what was coming next for Snappy and I was very excited to hear about easier cross-compilation methods as well as a cool script to help automate gathering the libraries in to your package.  I&#8217;ll find out more about these and follow up with another post about</p>
<h2>Special Thanks</h2>
<p>A huge &#8220;Thank You!&#8221; to <a title="https://plus.google.com/113078171667682980510/posts" href="https://plus.google.com/113078171667682980510/posts">Saviq</a> and <a title="https://www.google.com/+DidierRoche" href="https://www.google.com/+DidierRoche">Didrocks</a> for doing the actual work and letting me watch.</p>
<p>&nbsp;</p>
<h2>Where to get Snappy Mosquitto</h2>
<p>amd64 version:  <a title="https://myapps.developer.ubuntu.com/dev/click-apps/ubuntu/1500/" href="https://myapps.developer.ubuntu.com/dev/click-apps/ubuntu/1500/">https://myapps.developer.ubuntu.com/dev/click-apps/ubuntu/1500/</a><br>
armhf version: <a title="https://myapps.developer.ubuntu.com/dev/click-apps/ubuntu/1502/" href="https://myapps.developer.ubuntu.com/dev/click-apps/ubuntu/1502/">https://myapps.developer.ubuntu.com/dev/click-apps/ubuntu/1502/</a> (please note, I haven&#8217;t been able to test the ARM version because of a lack of hardware.  If it doesn&#8217;t work let me know and I can fix it.)</p>
        <div class="clearfix"></div>
          
       
    </section>
            <footer class="entry-footer">
                    <div class="meta">
					<span class="author">Posted by </span><a href="/author/will/" title="Posts by will" rel="author">will</a>                <span class="seporator">/</span>
                <span class="date-post h6">February 4, 2015</span>
                                                                                                                                                                                            <span class="seporator">/</span>
                        <span>Posted in</span>
                        <a href="/category/linux/" rel="category tag">linux</a><span>,</span> <a href="/category/making-the-world-a-better-place/" rel="category tag">Making the world a better place</a><span>,</span> <a href="/category/raspberrypi/" rel="category tag">RaspberryPi</a><span>,</span> <a href="/category/ubuntu-2/" rel="category tag">Ubuntu</a>                                                                </div>
            </footer>
    </article><!-- #post -->                                    <article id="post-590" class="post-in-blog post post-590 type-post status-publish format-standard hentry category-linux category-making-the-world-a-better-place category-ubuntu-2">
                    <header class="entry-header">
        <h2 class="entry-title">
            <a href="/2014/08/28/recording-screencasts-from-the-unity-8-desktop-preview/" rel="bookmark">Recording screencasts from the Unity 8 Desktop Preview</a>
        </h2>
    </header> 
    <section class="entry entry-content">
        <h1>Obtaining and running Unity 8 Desktop Preview</h1>
<p>If you like playing with new toys you might have already downloaded and tried the Unity 8 Desktop Preview (available here:  <a href="http://cdimage.ubuntu.com/ubuntu-desktop-next/daily-live/current/" target="_blank" rel="noopener noreferrer">http://cdimage.ubuntu.com/ubuntu-desktop-next/daily-live/current/</a>)</p>
<p>If you haven&#8217;t, you should take it for a spin.  If you have an Intel graphics everything should be fine and dandy, if not YMMV at the moment.</p>
<ol>
<li>Download the ISO</li>
<li>Find a spare &gt;1GB USB thumb drive</li>
<li>Run &#8220;disks&#8221; via the dash</li>
<li>Highlight your USB drive and from the cog icon on the right choose &#8220;Restore Disk Image&#8230;&#8221;</li>
<li>Select your ISO and &#8220;Start Restoring&#8221;  &#8211; this will of course erase everything else on your USB stick</li>
<li>Done</li>
</ol>
<p>You can now boot from your USB stick and have a play with Unity 8.  Right now you&#8217;ll be seeing the Phone view of Unity 8, but that will all be changing in time.</p>
<h1>Capturing a screencast</h1>
<p>Once you&#8217;ve got everything up and running you might like to make a few screencasts, so how do you do it?  Well, the Mir developers have provided us with the mirscreencast tool so let&#8217;s use that:</p>
<p>Switch to tty1 (ctrl+alt+f1) and log in and run:</p>
<pre>mirscreencast --file &lt;output file&gt; -m /run/lightdm-mir-0</pre>
<p>Then switch back to tty8 (ctrl-alt-f8) and use Unity.</p>
<p>Your file will now be filling up FAST.  Mirscreencast will be trying to write every raw frame to that file, probably at a rate of 60 frames a second.  To kill mirscreencast I first hit ctrl-z and then:</p>
<pre> pkill -9 mirscreencast</pre>
<p>but there is probably a better way.</p>
<h1>Capturing a better screencast</h1>
<p>There are a few command line options for mirscreencast which will can help us shrink the file size a bit:</p>
<pre>mirscreencast --file &lt;output file&gt; -m /run/lightdm-mir-0 -s 683 384 -n 3600</pre>
<p>The option &#8220;-s&#8221; will resize the captured frames.  Note that 683 384 is exactly half my native resolution, so you will need to adjust this to your display.</p>
<p>The option &#8220;-n&#8221; will capture n frames and then stop.  At 60 frames a second, 3600 frames is one minute.  If you use -n then mirscreencast will exit gracefully at the end.</p>
<h1>Playing back your screencast</h1>
<p>I am lucky enough to have a spare machine with a touch screen just for running Unity 8 on (<a href="http://www.dell.com/uk/dfh/p/inspiron-11-3137/pd" target="_blank" rel="noopener noreferrer">http://www.dell.com/uk/dfh/p/inspiron-11-3137/pd</a>) so I SCP the raw video file on to my main machine for playback and editing.</p>
<p>I use mplayer for most of my video playback and encoding needs and it will happily play the raw video file, but it needs a few pointers:</p>
<pre>mplayer -demuxer rawvideo -rawvideo fps=60:w=683:h=384:format=bgra &lt;filename&gt;</pre>
<p>or, to convert the raw file into something which you can edit in OpenShot try this:</p>
<pre>mencoder -demuxer rawvideo -rawvideo fps=60:w=683:h=384:format=bgra -ovc x264 -o &lt;output filename&gt; &lt;filename&gt;</pre>
<p>And then you can edit and upload the processed file.  When I export from OpenShot I use the &#8220;Web&#8221; profile, then target &#8220;YouTube-HD&#8221;, &#8220;HD 720p 29.97 fps&#8221; &#8220;Med&#8221; &#8211; it&#8217;s a bit overly compressed, but it looks OK.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
        <div class="clearfix"></div>
          
       
    </section>
            <footer class="entry-footer">
                    <div class="meta">
					<span class="author">Posted by </span><a href="/author/will/" title="Posts by will" rel="author">will</a>                <span class="seporator">/</span>
                <span class="date-post h6">August 28, 2014</span>
                                                                                                                                                                                            <span class="seporator">/</span>
                        <span>Posted in</span>
                        <a href="/category/linux/" rel="category tag">linux</a><span>,</span> <a href="/category/making-the-world-a-better-place/" rel="category tag">Making the world a better place</a><span>,</span> <a href="/category/ubuntu-2/" rel="category tag">Ubuntu</a>                                                                </div>
            </footer>
    </article><!-- #post -->                                                <nav class="navigation paging-navigation">
                    <a class="prev page-numbers" href="/category/making-the-world-a-better-place/page/2/">&laquo; Previous</a>
<a class="page-numbers" href="/category/making-the-world-a-better-place/">1</a>
<a class="page-numbers" href="/category/making-the-world-a-better-place/page/2/">2</a>
<span aria-current="page" class="page-numbers current">3</span>
<a class="page-numbers" href="/category/making-the-world-a-better-place/page/4/">4</a>
<a class="page-numbers" href="/category/making-the-world-a-better-place/page/5/">5</a>
<span class="page-numbers dots">&hellip;</span>
<a class="page-numbers" href="/category/making-the-world-a-better-place/page/7/">7</a>
<a class="next page-numbers" href="/category/making-the-world-a-better-place/page/4/">Next &raquo;</a>                </nav><!-- .navigation -->

            
        </div>
        <div class=" col-xs-12 col-sm-12 col-md-4 col-lg-4">
            <aside id="sidebar">
    <div class="widget-area">
                    <div id="archives-4" class="widget widget_archive">
<h3 class="widget-title">Archives</h3>
			<ul>
					<li><a href="/2021/07/">July 2021</a></li>
	<li><a href="/2021/01/">January 2021</a></li>
	<li><a href="/2019/07/">July 2019</a></li>
	<li><a href="/2019/06/">June 2019</a></li>
	<li><a href="/2019/05/">May 2019</a></li>
	<li><a href="/2017/05/">May 2017</a></li>
	<li><a href="/2017/03/">March 2017</a></li>
	<li><a href="/2017/02/">February 2017</a></li>
	<li><a href="/2016/12/">December 2016</a></li>
	<li><a href="/2016/11/">November 2016</a></li>
	<li><a href="/2016/10/">October 2016</a></li>
	<li><a href="/2016/09/">September 2016</a></li>
	<li><a href="/2016/02/">February 2016</a></li>
	<li><a href="/2015/12/">December 2015</a></li>
	<li><a href="/2015/10/">October 2015</a></li>
	<li><a href="/2015/09/">September 2015</a></li>
	<li><a href="/2015/06/">June 2015</a></li>
	<li><a href="/2015/05/">May 2015</a></li>
	<li><a href="/2015/02/">February 2015</a></li>
	<li><a href="/2014/08/">August 2014</a></li>
	<li><a href="/2014/02/">February 2014</a></li>
	<li><a href="/2014/01/">January 2014</a></li>
	<li><a href="/2013/12/">December 2013</a></li>
	<li><a href="/2013/11/">November 2013</a></li>
	<li><a href="/2013/02/">February 2013</a></li>
	<li><a href="/2012/11/">November 2012</a></li>
	<li><a href="/2012/08/">August 2012</a></li>
	<li><a href="/2012/03/">March 2012</a></li>
	<li><a href="/2011/09/">September 2011</a></li>
	<li><a href="/2011/08/">August 2011</a></li>
	<li><a href="/2011/07/">July 2011</a></li>
	<li><a href="/2011/06/">June 2011</a></li>
	<li><a href="/2011/04/">April 2011</a></li>
	<li><a href="/2011/02/">February 2011</a></li>
	<li><a href="/2010/10/">October 2010</a></li>
	<li><a href="/2010/09/">September 2010</a></li>
	<li><a href="/2010/08/">August 2010</a></li>
	<li><a href="/2010/06/">June 2010</a></li>
	<li><a href="/2010/01/">January 2010</a></li>
	<li><a href="/2009/10/">October 2009</a></li>
	<li><a href="/2009/09/">September 2009</a></li>
	<li><a href="/2009/08/">August 2009</a></li>
	<li><a href="/2009/07/">July 2009</a></li>
	<li><a href="/2009/06/">June 2009</a></li>
	<li><a href="/2009/05/">May 2009</a></li>
			</ul>

			</div>
		<div id="recent-posts-2" class="widget widget_recent_entries">
		<h3 class="widget-title">Recent Posts</h3>
		<ul>
											<li>
					<a href="/2021/07/14/finally-moving-to-a-static-site/">Finally moving to a static site</a>
									</li>
											<li>
					<a href="/2021/01/02/double-helping-of-pi-hole/">Double helping of Pi Hole</a>
									</li>
											<li>
					<a href="/2019/07/16/dns-over-https-in-a-snap/">DNS over HTTPS in a snap</a>
									</li>
											<li>
					<a href="/2019/06/11/whizzy-labs-wireless-sensor/">Whizzy Labs Wireless Sensor</a>
									</li>
											<li>
					<a href="/2019/05/07/ubuntu-developer-desktop-survey-2019/">Ubuntu Developer Desktop Survey 2019</a>
									</li>
					</ul>

		</div>
<div id="categories-4" class="widget widget_categories">
<h3 class="widget-title">Categories</h3>
			<ul>
					<li class="cat-item cat-item-2">
<a href="/category/alexa/">Alexa</a>
</li>
	<li class="cat-item cat-item-3">
<a href="/category/arduino/">Arduino</a>
</li>
	<li class="cat-item cat-item-4">
<a href="/category/asterisk/">asterisk</a>
</li>
	<li class="cat-item cat-item-5">
<a href="/category/google-maps/">Google Maps</a>
</li>
	<li class="cat-item cat-item-6">
<a href="/category/iot/">IoT</a>
</li>
	<li class="cat-item cat-item-7">
<a href="/category/javascript/">Javascript</a>
</li>
	<li class="cat-item cat-item-8">
<a href="/category/linux/">linux</a>
</li>
	<li class="cat-item cat-item-9 current-cat">
<a aria-current="page" href="/category/making-the-world-a-better-place/">Making the world a better place</a>
</li>
	<li class="cat-item cat-item-10">
<a href="/category/raspberrypi/">RaspberryPi</a>
</li>
	<li class="cat-item cat-item-12">
<a href="/category/so-called-humor/">So called humor</a>
</li>
	<li class="cat-item cat-item-13">
<a href="/category/tv/">tv</a>
</li>
	<li class="cat-item cat-item-14">
<a href="/category/ubuntu-2/">Ubuntu</a>
</li>
	<li class="cat-item cat-item-15">
<a href="/category/uncategorized/">Uncategorized</a>
</li>
			</ul>

			</div>            </div>
<!-- .widget-area -->
</aside>
        </div>
    </div>
</div>

</div>
<!-- #main -->
	<footer id="footer" class="site-footer">
		<a href="#" id="toTop" class="toTop"><i class="fa fa-angle-up"></i></a>
		<div class="footer-sidebar">
    <div class="container">
        <div class="row">            
                        <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
            <div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">
                            </div>
        </div>
<!-- .widget-area -->
    </div>
</div>		<div class="footer-inner">
			<div class="container">
								<p class="social-profile type1 pull-right">
																<a href="https://twitter.com/8none1" class="button-twitter" title="Twitter" target="_blank"><i class="fa fa-twitter-square"></i></a>
																					<a href="https://github.com/8none1" class="button-google" title="Google +" target="_blank"><i class="fa fa-google-plus-square"></i></a>
																															<a href="https://www.youtube.com/user/willcooke1" class="button-youtube" title="Youtube" target="_blank"><i class="fa fa-youtube-square"></i></a>
															                    
				</p>
				<p class="copyright"><span class="copyright-date">
						&copy; Copyright 2021                    </span>
										  <a href="/" title="whizzy.org" target="_blank">whizzy.org</a>
					  &#8226; Designed by <a href="https://motopress.com/" rel="nofollow" title="Premium WordPress Plugins and Themes">MotoPress</a>
					  &#8226; Proudly Powered by <a href="http://wordpress.org/" rel="nofollow" title="Semantic Personal Publishing Platform">WordPress</a>
					  				</p>
<!-- .copyright -->
			</div>
		</div>
	</footer>
</div>
<script type="text/javascript" src="/wp-includes/js/hoverIntent.min.js?ver=1.8.1" id="hoverIntent-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/superfish.min.js?ver=1.7.5" id="superfish.min-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/jquery.flexslider-min.js?ver=2.5.0" id="flexslider-js"></script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/jquery.appear.min.js?ver=0.3.6" id="jquery.appear-js"></script>
<script type="text/javascript" id="emmet-script-js-extra">
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
var template_directory_uri = {"url":"\/wp-content\/themes\/emmet-lite"};
/* ]]> */
</script>
<script type="text/javascript" src="/wp-content/themes/emmet-lite/js/emmet.min.js?ver=1.7.5" id="emmet-script-js"></script>
<script type="text/javascript" src="/wp-includes/js/wp-embed.min.js?ver=5.7.2" id="wp-embed-js"></script>
    <script>
        /(trident|msie)/i.test(navigator.userAgent)&&document.getElementById&&window.addEventListener&&window.addEventListener("hashchange",function(){var t,e=location.hash.substring(1);/^[A-z0-9_-]+$/.test(e)&&(t=document.getElementById(e))&&(/^(?:a|select|input|button|textarea)$/i.test(t.tagName)||(t.tabIndex=-1),t.focus())},!1);
    </script>
	</body>
</html>